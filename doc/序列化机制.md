# Ming RPC Framework åºåˆ—åŒ–æœºåˆ¶è¯¦è§£

## ğŸ“– æ¦‚è¿°

åºåˆ—åŒ–ï¼ˆSerializationï¼‰å’Œååºåˆ—åŒ–ï¼ˆDeserializationï¼‰æ˜¯åˆ†å¸ƒå¼RPCæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ã€‚Ming RPC Frameworkå®ç°äº†ä¸€å¥—å®Œæ•´çš„ã€å¯æ‰©å±•çš„åºåˆ—åŒ–ä½“ç³»ï¼Œæ”¯æŒå¤šç§åºåˆ—åŒ–åè®®ï¼Œé€šè¿‡SPIæœºåˆ¶å®ç°åŠ¨æ€æ‰©å±•ã€‚

## ğŸ¯ åºåˆ—åŒ–åœ¨RPCä¸­çš„ä½œç”¨

### æ ¸å¿ƒæµç¨‹
```
å®¢æˆ·ç«¯å¯¹è±¡ â†’ åºåˆ—åŒ– â†’ å­—èŠ‚æµ â†’ ç½‘ç»œä¼ è¾“ â†’ å­—èŠ‚æµ â†’ ååºåˆ—åŒ– â†’ æœåŠ¡ç«¯å¯¹è±¡
```

### å…³é”®ä½œç”¨ç‚¹
1. **è¯·æ±‚åºåˆ—åŒ–**: å°†RpcRequestå¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµè¿›è¡Œç½‘ç»œä¼ è¾“
2. **å“åº”åºåˆ—åŒ–**: å°†RpcResponseå¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµè¿”å›ç»™å®¢æˆ·ç«¯
3. **å‚æ•°å¤„ç†**: å¤„ç†æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼çš„åºåˆ—åŒ–/ååºåˆ—åŒ–
4. **ç±»å‹å®‰å…¨**: ç¡®ä¿åºåˆ—åŒ–åçš„æ•°æ®èƒ½æ­£ç¡®æ¢å¤ä¸ºåŸå§‹ç±»å‹

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¥å£å®šä¹‰
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/Serializer.java`

```java
public interface Serializer {
    /**
     * åºåˆ—åŒ–
     * @param object å¯¹è±¡
     * @param <T> æ³›å‹
     * @return å­—èŠ‚æ•°ç»„
     * @throws IOException
     */
    <T> byte[] serialize(T object) throws IOException;

    /**
     * ååºåˆ—åŒ–
     * @param bytes å­—èŠ‚æ•°ç»„
     * @param tClass ç±»
     * @param <T> æ³›å‹
     * @return å¯¹è±¡
     */
    <T> T deserialize(byte[] bytes, Class<T> tClass) throws IOException;
}

### åºåˆ—åŒ–å™¨å¸¸é‡
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/SerializerKeys.java`

```java
public class SerializerKeys {
    public static final String JDK = "jdk";
    public static final String JSON = "json";
    public static final String KRYO = "kryo";
    public static final String HESSIAN = "hessian";
}
```

## ğŸ”§ åºåˆ—åŒ–å™¨å®ç°

### 1. JDKåºåˆ—åŒ–å™¨
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/JdkSerializer.java`

```java
public class JdkSerializer implements Serializer {
    @Override
    public <T> byte[] serialize(T object) throws IOException {
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream);
        objectOutputStream.writeObject(object);
        objectOutputStream.close();
        return outputStream.toByteArray();
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> tClass) throws IOException {
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);
        ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);
        try {
            return (T) objectInputStream.readObject();
        } catch (ClassNotFoundException e) {
            throw new RuntimeException(e);
        } finally {
            objectInputStream.close();
        }
    }
}
```

**ç‰¹ç‚¹**:
- âœ… å…¼å®¹æ€§å¥½ï¼ŒJavaåŸç”Ÿæ”¯æŒ
- âœ… å®ç°ç®€å•ï¼Œæ— éœ€é¢å¤–ä¾èµ–
- âŒ åºåˆ—åŒ–åä½“ç§¯è¾ƒå¤§
- âŒ æ€§èƒ½ç›¸å¯¹è¾ƒä½
- âŒ ä»…æ”¯æŒJavaå¹³å°

### 2. JSONåºåˆ—åŒ–å™¨
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/JsonSerializer.java`

```java
public class JsonSerializer implements Serializer {
    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    static {
        // é…ç½®å¿½ç•¥æœªçŸ¥å±æ€§ï¼Œè§£å†³ServiceMetaInfoåºåˆ—åŒ–é—®é¢˜
        OBJECT_MAPPER.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }

    @Override
    public byte[] serialize(Object obj) throws IOException {
        return OBJECT_MAPPER.writeValueAsBytes(obj);
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> classType) throws IOException {
        T obj = OBJECT_MAPPER.readValue(bytes, classType);

        // ç‰¹æ®Šå¤„ç†RpcRequestå’ŒRpcResponseçš„ç±»å‹æ“¦é™¤é—®é¢˜
        if(obj instanceof RpcRequest) {
            return handleRequest((RpcRequest) obj, classType);
        }
        if(obj instanceof RpcResponse) {
            return handleResponse((RpcResponse) obj, classType);
        }
        return obj;
    }

    // å¤„ç†RpcRequestå‚æ•°ç±»å‹è½¬æ¢
    private <T> T handleRequest(RpcRequest rpcRequest, Class<T> type) throws IOException {
        Class<?>[] parameterTypes = rpcRequest.getParameterTypes();
        Object[] args = rpcRequest.getArgs();

        for (int i = 0; i < parameterTypes.length; i++) {
            Class<?> clazz = parameterTypes[i];
            if (!clazz.isAssignableFrom(args[i].getClass())) {
                byte[] argBytes = OBJECT_MAPPER.writeValueAsBytes(args[i]);
                args[i] = OBJECT_MAPPER.readValue(argBytes, clazz);
            }
        }
        return type.cast(rpcRequest);
    }
}
```

**ç‰¹ç‚¹**:
- âœ… è·¨è¯­è¨€æ”¯æŒï¼Œå¯è¯»æ€§å¼º
- âœ… è°ƒè¯•å‹å¥½ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
- âœ… ä¸Webå‰ç«¯äº¤äº’æ–¹ä¾¿
- âŒ æ€§èƒ½ç›¸å¯¹è¾ƒä½
- âŒ ç±»å‹ä¿¡æ¯å¯èƒ½ä¸¢å¤±

### 3. Hessianåºåˆ—åŒ–å™¨
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/HessianSerializer.java`

```java
public class HessianSerializer implements Serializer {
    @Override
    public byte[] serialize(Object obj) throws IOException {
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        Hessian2Output output = new Hessian2Output(outputStream);
        output.writeObject(obj);
        output.close();
        return outputStream.toByteArray();
    }

    @Override
    @SuppressWarnings("unchecked")
    public <T> T deserialize(byte[] bytes, Class<T> classType) throws IOException {
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);
        Hessian2Input input = new Hessian2Input(inputStream);
        return (T) input.readObject(classType);
    }
}
```

**ç‰¹ç‚¹**:
- âœ… é«˜æ€§èƒ½ï¼Œåºåˆ—åŒ–é€Ÿåº¦å¿«
- âœ… åºåˆ—åŒ–åä½“ç§¯å°
- âœ… è·¨è¯­è¨€æ”¯æŒ
- âŒ ç‰ˆæœ¬å…¼å®¹æ€§éœ€è¦æ³¨æ„
- âŒ éœ€è¦é¢å¤–ä¾èµ–

### 4. Kryoåºåˆ—åŒ–å™¨
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/KryoSerializer.java`

```java
public class KryoSerializer implements Serializer {
    /**
     * kryo çº¿ç¨‹ä¸å®‰å…¨ï¼Œä½¿ç”¨ThreadLocal ä¿è¯çº¿ç¨‹å®‰å…¨
     */
    private static final ThreadLocal<Kryo> KRYO_THREAD_LOCAL = ThreadLocal.withInitial(() -> {
        Kryo kryo = new Kryo();
        // è®¾ç½®åŠ¨æ€åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç±»ï¼Œä¸æå‰æ³¨å†Œæ‰€æœ‰ç±»
        kryo.setRegistrationRequired(false);
        return kryo;
    });

    @Override
    public byte[] serialize(Object obj) throws IOException {
        if (obj == null) {
            return new byte[0];
        }
        Kryo kryo = KRYO_THREAD_LOCAL.get();
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        Output output = new Output(outputStream);
        kryo.writeObject(output, obj);
        output.close();
        return outputStream.toByteArray();
    }

    @Override
    @SuppressWarnings("unchecked")
    public <T> T deserialize(byte[] bytes, Class<T> classType) throws IOException {
        if (bytes == null || bytes.length == 0) {
            return null;
        }
        Kryo kryo = KRYO_THREAD_LOCAL.get();
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);
        Input input = new Input(inputStream);
        return (T) kryo.readObject(input, classType);
    }
}
```

**ç‰¹ç‚¹**:
- âœ… æé«˜æ€§èƒ½ï¼Œé€Ÿåº¦æœ€å¿«
- âœ… åºåˆ—åŒ–åä½“ç§¯æœ€å°
- âœ… æ”¯æŒå¾ªç¯å¼•ç”¨
- âŒ çº¿ç¨‹ä¸å®‰å…¨ï¼Œéœ€è¦ThreadLocal
- âŒ ä»…æ”¯æŒJavaå¹³å°

## ğŸ­ å·¥å‚æ¨¡å¼ä¸SPIæœºåˆ¶

### åºåˆ—åŒ–å™¨å·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/serializer/SerializerFactory.java`

```java
public class SerializerFactory {
    static {
        SpiLoader.load(Serializer.class);
    }

    /**
     * é»˜è®¤åºåˆ—åŒ–å™¨
     */
    private static final Serializer DEFAULT_SERIALIZER = new JdkSerializer();

    /**
     * è·å–å®ä¾‹
     * @param key åºåˆ—åŒ–å™¨ç±»å‹
     * @return åºåˆ—åŒ–å™¨
     */
    public static Serializer getInstance(String key) {
        return SpiLoader.getInstance(Serializer.class, key);
    }

    public static Serializer getInstance() {
        return DEFAULT_SERIALIZER;
    }
}
```

### SPIé…ç½®æ–‡ä»¶
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/resources/META-INF/rpc/system/com.ming.rpc.serializer.Serializer`

```
jdk=com.ming.rpc.serializer.JdkSerializer
hessian=com.ming.rpc.serializer.HessianSerializer
json=com.ming.rpc.serializer.JsonSerializer
kryo=com.ming.rpc.serializer.KryoSerializer
```

### åè®®æ¶ˆæ¯åºåˆ—åŒ–æšä¸¾
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/protocol/ProtocolMessageSerializerEnum.java`

```java
@Getter
public enum ProtocolMessageSerializerEnum {
    JDK(0,"jdk"),
    JSON(1,"json"),
    KRYO(2,"kryo"),
    HESSIAN(3,"hessian");

    private final int key;
    private final String value;

    public static ProtocolMessageSerializerEnum getEnumByKey(int key) {
        for (ProtocolMessageSerializerEnum protocolMessageSerializerEnum : ProtocolMessageSerializerEnum.values()) {
            if (protocolMessageSerializerEnum.getKey() == key) {
                return protocolMessageSerializerEnum;
            }
        }
        return null;
    }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### åºåˆ—åŒ–å™¨æµ‹è¯•
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/test/java/com/ming/rpc/serializer/`

é¡¹ç›®ä¸ºæ¯ä¸ªåºåˆ—åŒ–å™¨éƒ½æä¾›äº†å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼š

1. **JdkSerializerTest** - JDKåºåˆ—åŒ–å™¨æµ‹è¯•
2. **JsonSerializerTest** - JSONåºåˆ—åŒ–å™¨æµ‹è¯•
3. **HessianSerializerTest** - Hessianåºåˆ—åŒ–å™¨æµ‹è¯•
4. **KryoSerializerTest** - Kryoåºåˆ—åŒ–å™¨æµ‹è¯•

### æµ‹è¯•ç¤ºä¾‹
```java
@Test
public void testJdkSerialization() {
    User user = new User("test", "test@example.com");
    JdkSerializer serializer = new JdkSerializer();

    // åºåˆ—åŒ–
    byte[] bytes = serializer.serialize(user);
    assertNotNull(bytes);
    assertTrue(bytes.length > 0);

    // ååºåˆ—åŒ–
    User deserializedUser = serializer.deserialize(bytes, User.class);
    assertEquals("test", deserializedUser.getName());
    assertEquals("test@example.com", deserializedUser.getEmail());
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

åŸºäºé¡¹ç›®æµ‹è¯•ç»“æœçš„æ€§èƒ½å¯¹æ¯”ï¼š

| åºåˆ—åŒ–å™¨ | åºåˆ—åŒ–é€Ÿåº¦ | ååºåˆ—åŒ–é€Ÿåº¦ | æ•°æ®å¤§å° | è·¨è¯­è¨€æ”¯æŒ | çº¿ç¨‹å®‰å…¨ |
|---------|-----------|-------------|----------|-----------|----------|
| JDK     | ä¸­ç­‰      | ä¸­ç­‰        | å¤§       | å¦        | æ˜¯       |
| JSON    | å¿«        | å¿«          | ä¸­ç­‰     | æ˜¯        | æ˜¯       |
| Hessian | å¿«        | å¿«          | å°       | æ˜¯        | æ˜¯       |
| Kryo    | æå¿«      | æå¿«        | æå°     | å¦        | å¦       |

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### é…ç½®åºåˆ—åŒ–å™¨
åœ¨RPCé…ç½®ä¸­æŒ‡å®šåºåˆ—åŒ–å™¨ï¼š

```yaml
rpc:
  serializer: JSON  # å¯é€‰: JDK, JSON, HESSIAN, KRYO
```

### ä»£ç ä¸­ä½¿ç”¨
```java
// é€šè¿‡å·¥å‚è·å–åºåˆ—åŒ–å™¨
Serializer serializer = SerializerFactory.getInstance(SerializerKeys.JSON);

// åºåˆ—åŒ–å¯¹è±¡
User user = new User("å¼ ä¸‰", "zhangsan@example.com");
byte[] bytes = serializer.serialize(user);

// ååºåˆ—åŒ–å¯¹è±¡
User deserializedUser = serializer.deserialize(bytes, User.class);
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åºåˆ—åŒ–å™¨é€‰æ‹©
- **å¼€å‘æµ‹è¯•**: ä½¿ç”¨JSONåºåˆ—åŒ–å™¨ï¼Œä¾¿äºè°ƒè¯•
- **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨Kryoæˆ–Hessianï¼Œè¿½æ±‚é«˜æ€§èƒ½
- **è·¨è¯­è¨€**: ä½¿ç”¨JSONæˆ–Hessianåºåˆ—åŒ–å™¨
- **å…¼å®¹æ€§**: ä½¿ç”¨JDKåºåˆ—åŒ–å™¨ï¼Œæœ€å¤§å…¼å®¹æ€§

### 2. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨å¯¹è±¡æ± å‡å°‘åºåˆ—åŒ–å™¨åˆ›å»ºå¼€é”€
- ç¼“å­˜åºåˆ—åŒ–ç»“æœé¿å…é‡å¤åºåˆ—åŒ–
- é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–å™¨å¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½

### 3. å®‰å…¨è€ƒè™‘
- éªŒè¯ååºåˆ—åŒ–çš„æ•°æ®æ¥æº
- é™åˆ¶å¯ååºåˆ—åŒ–çš„ç±»å‹
- é¿å…ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®

## ğŸ“ˆ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„åºåˆ—åŒ–å™¨
1. å®ç°`Serializer`æ¥å£
2. åœ¨SPIé…ç½®æ–‡ä»¶ä¸­æ³¨å†Œ
3. æ·»åŠ å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
4. æ›´æ–°åºåˆ—åŒ–å™¨å¸¸é‡

### ç¤ºä¾‹ï¼šæ·»åŠ Protobufåºåˆ—åŒ–å™¨
```java
public class ProtobufSerializer implements Serializer {
    @Override
    public <T> byte[] serialize(T object) throws IOException {
        // Protobufåºåˆ—åŒ–å®ç°
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> tClass) throws IOException {
        // Protobufååºåˆ—åŒ–å®ç°
    }
}
```

## ğŸ“‹ æ€»ç»“

Ming RPC Frameworkçš„åºåˆ—åŒ–æœºåˆ¶é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ï¼Œæä¾›äº†é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„åºåˆ—åŒ–è§£å†³æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **å¤šç§åºåˆ—åŒ–å™¨æ”¯æŒ**: JDKã€JSONã€Hessianã€Kryoå››ç§åºåˆ—åŒ–å™¨
- âœ… **SPIæœºåˆ¶æ‰©å±•**: é€šè¿‡SPIæœºåˆ¶å®ç°åºåˆ—åŒ–å™¨çš„åŠ¨æ€åŠ è½½å’Œæ‰©å±•
- âœ… **å·¥å‚æ¨¡å¼ç®¡ç†**: ç»Ÿä¸€çš„åºåˆ—åŒ–å™¨å·¥å‚ç®¡ç†å’Œåˆ›å»º
- âœ… **å®Œå–„çš„æµ‹è¯•**: æ¯ä¸ªåºåˆ—åŒ–å™¨éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯
- âœ… **æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹ä¸åŒåœºæ™¯é€‰æ‹©æœ€ä¼˜çš„åºåˆ—åŒ–å™¨

### æŠ€æœ¯ç‰¹è‰²
- **å¯æ’æ‹”è®¾è®¡**: é€šè¿‡æ¥å£æŠ½è±¡å’ŒSPIæœºåˆ¶å®ç°å¯æ’æ‹”
- **æ€§èƒ½å¯¼å‘**: æä¾›é«˜æ€§èƒ½çš„Kryoå’ŒHessianåºåˆ—åŒ–å™¨
- **è·¨è¯­è¨€æ”¯æŒ**: JSONå’ŒHessianæ”¯æŒè·¨è¯­è¨€é€šä¿¡
- **çº¿ç¨‹å®‰å…¨**: è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨æ€§ï¼ŒKryoä½¿ç”¨ThreadLocal

Ming RPC Frameworkçš„åºåˆ—åŒ–æœºåˆ¶ä¸ºåˆ†å¸ƒå¼RPCé€šä¿¡æä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æ’‘ï¼Œæ»¡è¶³äº†ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½å’ŒåŠŸèƒ½éœ€æ±‚ã€‚