# Ming RPC Framework æœåŠ¡æ³¨å†Œä¸­å¿ƒåŸç†ä¸å®ç°è¯¦è§£

## ğŸ“– æ¦‚è¿°

æœåŠ¡æ³¨å†Œä¸­å¿ƒæ˜¯åˆ†å¸ƒå¼RPCæ¡†æ¶çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œè´Ÿè´£æœåŠ¡çš„æ³¨å†Œã€å‘ç°ã€å¥åº·æ£€æŸ¥å’Œé…ç½®ç®¡ç†ã€‚Ming RPC Frameworkå®ç°äº†ä¸€å¥—å®Œæ•´çš„ã€å¯æ‰©å±•çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒä½“ç³»ï¼Œæ”¯æŒå¤šç§æ³¨å†Œä¸­å¿ƒå®ç°ï¼Œé€šè¿‡SPIæœºåˆ¶å®ç°åŠ¨æ€æ‰©å±•ã€‚

## ğŸ¯ æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨

### æ ¸å¿ƒä»·å€¼
1. **æœåŠ¡å‘ç°**: è®©æœåŠ¡æ¶ˆè´¹è€…èƒ½å¤ŸåŠ¨æ€å‘ç°æœåŠ¡æä¾›è€…çš„ç½‘ç»œä½ç½®
2. **æœåŠ¡æ³¨å†Œ**: æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
3. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æµ‹æœåŠ¡å®ä¾‹çš„å¥åº·çŠ¶æ€ï¼Œå‰”é™¤ä¸å¯ç”¨å®ä¾‹
4. **è´Ÿè½½å‡è¡¡æ”¯æŒ**: ä¸ºè´Ÿè½½å‡è¡¡å™¨æä¾›å¯ç”¨æœåŠ¡å®ä¾‹åˆ—è¡¨
5. **é…ç½®ç®¡ç†**: é›†ä¸­ç®¡ç†æœåŠ¡ç›¸å…³çš„é…ç½®ä¿¡æ¯

### åœ¨RPCä¸­çš„ä½ç½®
```
æœåŠ¡æä¾›è€… â†’ æœåŠ¡æ³¨å†Œ â†’ æ³¨å†Œä¸­å¿ƒ â† æœåŠ¡å‘ç° â† æœåŠ¡æ¶ˆè´¹è€…
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¥å£å®šä¹‰
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/registry/Registry.java`

```java
public interface Registry {
    /**
     * åˆå§‹åŒ–
     * @param registryConfig æ³¨å†Œä¸­å¿ƒé…ç½®
     */
    void init(RegistryConfig registryConfig);

    /**
     * æ³¨å†ŒæœåŠ¡ï¼ŒæœåŠ¡ç«¯
     * @param serviceMetaInfo æœåŠ¡å…ƒä¿¡æ¯
     */
    void register(ServiceMetaInfo serviceMetaInfo) throws Exception;

    /**
     * æ³¨é”€æœåŠ¡ï¼ŒæœåŠ¡ç«¯
     * @param serviceMetaInfo æœåŠ¡å…ƒä¿¡æ¯
     */
    void unregister(ServiceMetaInfo serviceMetaInfo);

    /**
     * æœåŠ¡å‘ç°ï¼ˆè·å–æŸæœåŠ¡æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ¶ˆè´¹ç«¯ï¼‰
     * @param serviceKey æœåŠ¡é”®å
     * @return
     */
    List<ServiceMetaInfo> serviceDiscovery(String serviceKey);

    /**
     * å¿ƒè·³æ£€æµ‹ ï¼ˆ æœåŠ¡ç«¯ï¼‰
     */
    void heartbeat();

     /**
      * ç›‘å¬ï¼ˆæ¶ˆè´¹ç«¯)
      * @param serviceNodeKey
      */
      void watch(String serviceNodeKey);

      /**
       * æœåŠ¡é”€æ¯
       */
      void destroy();
}
```

### æœåŠ¡å…ƒä¿¡æ¯æ¨¡å‹
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/model/ServiceMetaInfo.java`

```java
@Data
public class ServiceMetaInfo implements Serializable {
    /**
     * æœåŠ¡åç§°
     */
    private String serviceName;

    /**
     * æœåŠ¡ç‰ˆæœ¬å·
     */
    private String serviceVersion = RpcConstant.DEFAULT_SERVICE_VERSION;

    /**
     * æœåŠ¡åŸŸå
     */
    private String serviceHost;

    /**
     * æœåŠ¡ç«¯å£
     */
    private Integer servicePort;

    /**
     * æœåŠ¡åˆ†ç»„ï¼ˆæš‚æœªå®ç°ï¼‰
     */
    private String serviceGroup = "default";

    /**
     * è·å–æœåŠ¡é”®å
     */
    public String getServiceKey() {
        return String.format("%s:%s", serviceName, serviceVersion);
    }

    /**
     * è·å–æœåŠ¡æ³¨å†ŒèŠ‚ç‚¹é”®å
     */
    public String getServiceNodeKey() {
        return String.format("%s/%s:%s", getServiceKey(), serviceHost, servicePort);
    }

    /**
     * è·å–å®Œæ•´æœåŠ¡åœ°å€
     */
    public String getServiceAddress() {
        if(!StrUtil.contains(serviceHost, "http")) {
            return String.format("http://%s:%s", serviceHost, servicePort);
        }
        return String.format("%s:%s", serviceHost, servicePort);
    }
}
```

### æœåŠ¡æ³¨å†Œä¸­å¿ƒå·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant P as æœåŠ¡æä¾›è€…
    participant R as æœåŠ¡æ³¨å†Œä¸­å¿ƒ
    participant C as æœåŠ¡æ¶ˆè´¹è€…
    
    P->>R: 1. æ³¨å†ŒæœåŠ¡(æœåŠ¡å, åœ°å€, ç«¯å£)
    P->>R: 2. å®šæœŸå‘é€å¿ƒè·³
    C->>R: 3. æŸ¥è¯¢æœåŠ¡(æœåŠ¡å)
    R-->>C: 4. è¿”å›æœåŠ¡å®ä¾‹åˆ—è¡¨
    C->>P: 5. ç›´æ¥è°ƒç”¨æœåŠ¡
    
    Note over P,R: æœåŠ¡æä¾›è€…ä¸‹çº¿
    P->>R: 6. æ³¨é”€æœåŠ¡(ä¸»åŠ¨ä¸‹çº¿)
    Note over P,R: æˆ–å¿ƒè·³è¶…æ—¶(è¢«åŠ¨ä¸‹çº¿)
    R->>R: 7. ç§»é™¤æœåŠ¡å®ä¾‹
```

ä¸Šå›¾å±•ç¤ºäº†æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åŸºæœ¬å·¥ä½œæµç¨‹ï¼š

1. æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±çš„æœåŠ¡ä¿¡æ¯
2. æœåŠ¡æä¾›è€…å®šæœŸå‘æ³¨å†Œä¸­å¿ƒå‘é€å¿ƒè·³ï¼Œè¡¨æ˜è‡ªå·±å¤„äºå¯ç”¨çŠ¶æ€
3. æœåŠ¡æ¶ˆè´¹è€…ä»æ³¨å†Œä¸­å¿ƒæŸ¥è¯¢æ‰€éœ€æœåŠ¡çš„å®ä¾‹åˆ—è¡¨
4. æ³¨å†Œä¸­å¿ƒè¿”å›ç¬¦åˆæ¡ä»¶çš„æœåŠ¡å®ä¾‹ä¿¡æ¯
5. æœåŠ¡æ¶ˆè´¹è€…æ ¹æ®è·å–çš„ä¿¡æ¯ç›´æ¥è°ƒç”¨æœåŠ¡æä¾›è€…
6. æœåŠ¡æä¾›è€…ä¸‹çº¿æ—¶ä¸»åŠ¨é€šçŸ¥æ³¨å†Œä¸­å¿ƒæ³¨é”€æœåŠ¡
7. å¦‚æœæœåŠ¡æä¾›è€…å¼‚å¸¸å®•æœºï¼Œæ³¨å†Œä¸­å¿ƒé€šè¿‡å¿ƒè·³è¶…æ—¶æœºåˆ¶æ£€æµ‹åˆ°å¹¶ç§»é™¤ç›¸åº”æœåŠ¡å®ä¾‹

## ğŸ”§ æ³¨å†Œä¸­å¿ƒå®ç°

### 1. ETCDæ³¨å†Œä¸­å¿ƒ
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/registry/EtcdRegistry.java`

```java
public class EtcdRegistry implements Registry {
    private Client client;
    private KV kvClient;
    private static final String ETCD_ROOT_PATH = "/rpc/";

    @Override
    public void init(RegistryConfig registryConfig) {
        client = Client.builder()
                .endpoints(registryConfig.getAddress())
                .connectTimeout(Duration.ofMillis(registryConfig.getTimeout()))
                .build();
        kvClient = client.getKVClient();
        heartbeat();
    }

    @Override
    public void register(ServiceMetaInfo serviceMetaInfo) throws Exception {
        // åˆ›å»ºLease å’ŒKV å®¢æˆ·ç«¯
        Lease leaseClient = client.getLeaseClient();

        // åˆ›å»ºä¸€ä¸ª30ç§’çš„ç§Ÿçº¦
        long leaseId = leaseClient.grant(30).get().getID();

        // è®¾ç½®è¦å­˜å‚¨çš„é”®å€¼å¯¹
        String registerKey = ETCD_ROOT_PATH + serviceMetaInfo.getServiceNodeKey();
        ByteSequence key = ByteSequence.from(registerKey, StandardCharsets.UTF_8);
        ByteSequence value = ByteSequence.from(JSONUtil.toJsonStr(serviceMetaInfo), StandardCharsets.UTF_8);

        // å°†é”®å€¼å¯¹ä¸ç§Ÿçº¦å…³è”èµ·æ¥ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        PutOption putOption = PutOption.builder().withLeaseId(leaseId).build();
        kvClient.put(key, value, putOption).get();
        // æ·»åŠ èŠ‚ç‚¹ä¿¡æ¯åˆ°æœ¬åœ°ç¼“å­˜
        localRegisterNodeKeySet.add(registerKey);
    }

    @Override
    public List<ServiceMetaInfo> serviceDiscovery(String serviceKey) {
        // ä¼˜å…ˆä»ç¼“å­˜è·å–æœåŠ¡
        List<ServiceMetaInfo> cachedServiceMetaInfoList = registryServiceMultiCache.readCache(serviceKey);
        if(cachedServiceMetaInfoList != null){
            return cachedServiceMetaInfoList;
        }

        // å‰ç¼€æœç´¢ï¼Œç»“å°¾ä¸€å®šè¦åŠ  '/'
        String searchPrefix = ETCD_ROOT_PATH + serviceKey + "/";

        try {
            // å‰ç¼€æœç´¢
            GetOption getOption = GetOption.builder().isPrefix(true).build();
            List<KeyValue> keyValues = kvClient.get(ByteSequence.from(searchPrefix, StandardCharsets.UTF_8), getOption).get().getKvs();
            // è§£ææœåŠ¡ä¿¡æ¯
            List<ServiceMetaInfo> serviceMetaInfoList = keyValues.stream()
            .map(keyValue -> {
                String key = keyValue.getKey().toString(StandardCharsets.UTF_8);
                // ç›‘å¬KEYçš„å˜åŒ–
                watch(key);
                // è§£ææœåŠ¡ä¿¡æ¯
                String value = keyValue.getValue().toString(StandardCharsets.UTF_8);
                return JSONUtil.toBean(value, ServiceMetaInfo.class);
            }).collect(Collectors.toList());
            // å†™å…¥æœåŠ¡ç¼“å­˜
            registryServiceMultiCache.writeCache(serviceKey, serviceMetaInfoList);
            return serviceMetaInfoList;
        } catch (Exception e) {
            throw new RuntimeException("æœåŠ¡å‘ç°å¤±è´¥", e);
        }
    }
}
```

**ç‰¹ç‚¹**:
- âœ… é«˜æ€§èƒ½ï¼Œä½å»¶è¿Ÿçš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨
- âœ… åŸºäºRaftç®—æ³•ä¿è¯å¼ºä¸€è‡´æ€§
- âœ… æ”¯æŒTTLç§Ÿçº¦æœºåˆ¶ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæœåŠ¡
- âœ… æ”¯æŒå‰ç¼€æœç´¢å’ŒWatchç›‘å¬
- âŒ éœ€è¦é¢å¤–éƒ¨ç½²ETCDé›†ç¾¤

**é€‚ç”¨åœºæ™¯**: é«˜æ€§èƒ½è¦æ±‚ã€å¼ºä¸€è‡´æ€§éœ€æ±‚çš„ç”Ÿäº§ç¯å¢ƒ
### 2. ZooKeeperæ³¨å†Œä¸­å¿ƒ
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/registry/ZooKeeperRgistry.java`

```java
public class ZooKeeperRgistry implements Registry {
    private CuratorFramework client;
    private ServiceDiscovery<ServiceMetaInfo> serviceDiscovery;
    private final Set<String> localRegisterNodeKeySet = new ConcurrentHashSet<>();
    private final RegistryServiceCache registryServiceCache = new RegistryServiceCache();

    @Override
    public void init(RegistryConfig registryConfig) {
        // æ„å»ºå®¢æˆ·ç«¯
        client = CuratorFrameworkFactory
                .builder()
                .connectString(registryConfig.getAddress())
                .retryPolicy(new ExponentialBackoffRetry(Math.toIntExact(registryConfig.getTimeout()), 3))
                .build();

        // æ„å»º serviceDiscovery å®ä¾‹
        serviceDiscovery = ServiceDiscoveryBuilder.builder(ServiceMetaInfo.class)
                .client(client)
                .basePath(ZK_ROOT_PATH)
                .serializer(JsonInstanceSerializer.forType(ServiceMetaInfo.class))
                .build();

        try {
            // å¯åŠ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å‘ç°
            client.start();
            serviceDiscovery.start();
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public void register(ServiceMetaInfo serviceMetaInfo) throws Exception {
        // æ³¨å†Œåˆ° ZK ä¸­
        serviceDiscovery.registerService(buildServiceInstance(serviceMetaInfo));

        // æ·»åŠ èŠ‚ç‚¹ä¿¡æ¯åˆ°æœ¬åœ°ç¼“å­˜
        String serviceNodeKey = buildServiceNodeKey(serviceMetaInfo);
        localRegisterNodeKeySet.add(serviceNodeKey);
    }

    @Override
    public List<ServiceMetaInfo> serviceDiscovery(String serviceKey) {
        // ä¼˜å…ˆä»ç¼“å­˜è·å–
        List<ServiceMetaInfo> cachedServiceMetaInfoList = registryServiceCache.readCache(serviceKey);
        if (cachedServiceMetaInfoList != null) {
            return cachedServiceMetaInfoList;
        }
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ³¨å†Œä¸­å¿ƒè¯»å–å¹¶è®¾ç½®ç›‘å¬
        return discoverAndCache(serviceKey);
    }

    private List<ServiceMetaInfo> discoverAndCache(String serviceKey) {
        try {
            // ä»æ³¨å†Œä¸­å¿ƒè¯»å–
            Collection<ServiceInstance<ServiceMetaInfo>> serviceInstanceCollection = serviceDiscovery.queryForInstances(serviceKey);
            // é¦–æ¬¡å‘ç°ï¼Œå»ºç«‹ç›‘å¬
            watch(serviceKey);
            // å†™å…¥ç¼“å­˜
            List<ServiceMetaInfo> serviceMetaInfoList = serviceInstanceCollection.stream()
                    .map(ServiceInstance::getPayload)
                    .collect(Collectors.toList());
            registryServiceCache.writeCache(serviceKey, serviceMetaInfoList);
            return serviceMetaInfoList;
        } catch (Exception e) {
            throw new RuntimeException("è·å–æœåŠ¡åˆ—è¡¨å¤±è´¥", e);
        }
    }
}
```

**ç‰¹ç‚¹**:
- âœ… æˆç†Ÿç¨³å®šï¼Œå¹¿æ³›åº”ç”¨äºå¤§æ•°æ®ç”Ÿæ€
- âœ… å¼ºä¸€è‡´æ€§ä¿è¯ï¼ŒåŸºäºZABåè®®
- âœ… æ”¯æŒç›‘å¬æœºåˆ¶ï¼Œå®æ—¶æ„ŸçŸ¥æœåŠ¡å˜åŒ–
- âœ… æ ‘å½¢æ•°æ®ç»“æ„ï¼Œä¾¿äºç®¡ç†
- âŒ æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè¿ç»´å¤æ‚åº¦é«˜

**é€‚ç”¨åœºæ™¯**: å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„ä¼ä¸šçº§åº”ç”¨

### 3. Mockæ³¨å†Œä¸­å¿ƒ (æµ‹è¯•ç”¨)
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/test/java/com/ming/rpc/registry/MockRegistry.java`

```java
public class MockRegistry implements Registry {
    private final Map<String, List<ServiceMetaInfo>> registryMap = new ConcurrentHashMap<>();

    @Override
    public void init(RegistryConfig registryConfig) {
        // Mock æ³¨å†Œä¸­å¿ƒæ— éœ€åˆå§‹åŒ–
    }

    @Override
    public void register(ServiceMetaInfo serviceMetaInfo) throws Exception {
        List<ServiceMetaInfo> serviceMetaInfos = registryMap.getOrDefault(serviceMetaInfo.getServiceKey(), new ArrayList<>());
        serviceMetaInfos.add(serviceMetaInfo);
        registryMap.put(serviceMetaInfo.getServiceKey(), serviceMetaInfos);
    }

    @Override
    public void unregister(ServiceMetaInfo serviceMetaInfo) {
        List<ServiceMetaInfo> serviceMetaInfos = registryMap.getOrDefault(serviceMetaInfo.getServiceKey(), new ArrayList<>());
        serviceMetaInfos.remove(serviceMetaInfo);
        registryMap.put(serviceMetaInfo.getServiceKey(), serviceMetaInfos);
    }

    @Override
    public List<ServiceMetaInfo> serviceDiscovery(String serviceKey) {
        return registryMap.getOrDefault(serviceKey, new ArrayList<>());
    }

    @Override
    public void destroy() {
        registryMap.clear();
    }

    @Override
    public void heartbeat() {
        // æµ‹è¯•æ— éœ€å¿ƒè·³
    }

    @Override
    public void watch(String serviceNodeKey) {
        // æµ‹è¯•æ— éœ€ç›‘å¬
    }
}
```

**ç‰¹ç‚¹**:
- âœ… è½»é‡çº§ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–
- âœ… é€‚ç”¨äºå•å…ƒæµ‹è¯•å’Œå¼€å‘ç¯å¢ƒ
- âœ… å®ç°ç®€å•ï¼Œå¯åŠ¨å¿«é€Ÿ
- âŒ ä»…å†…å­˜å­˜å‚¨ï¼Œé‡å¯åæ•°æ®ä¸¢å¤±
- âŒ ä¸æ”¯æŒåˆ†å¸ƒå¼åœºæ™¯

**é€‚ç”¨åœºæ™¯**: å•å…ƒæµ‹è¯•ã€å¼€å‘ç¯å¢ƒã€æ¼”ç¤ºç¯å¢ƒ

## ğŸ­ å·¥å‚æ¨¡å¼ä¸SPIæœºåˆ¶

### æ³¨å†Œä¸­å¿ƒå·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/registry/RegistryFactory.java`

```java
public class RegistryFactory {
    static {
        SpiLoader.load(Registry.class);
    }

    /**
     * é»˜è®¤æ³¨å†Œä¸­å¿ƒ
     */
    private static final Registry DEFAULT_REGISTRY = new EtcdRegistry();

    /**
     * è·å–å®ä¾‹
     * @param key æ³¨å†Œä¸­å¿ƒç±»å‹
     * @return æ³¨å†Œä¸­å¿ƒ
     */
    public static Registry getInstance(String key) {
        return SpiLoader.getInstance(Registry.class, key);
    }
}
```

### æ³¨å†Œä¸­å¿ƒå¸¸é‡
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/registry/RegistryKeys.java`

```java
public interface RegistryKeys {
    String ETCD = "etcd";
    String ZOOKEEPER = "zookeeper";
    String CONSUL = "consul";
    String REDIS = "redis";
    String NACOS = "nacos";
}
```

### SPIé…ç½®æ–‡ä»¶
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/resources/META-INF/rpc/system/com.ming.rpc.registry.Registry`

```
etcd=com.ming.rpc.registry.EtcdRegistry
zookeeper=com.ming.rpc.registry.ZooKeeperRgistry
consul=com.ming.rpc.registry.ConsulRegistry
redis=com.ming.rpc.registry.RedisRegistry
nacos=com.ming.rpc.registry.NacosRegistry
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ³¨å†Œä¸­å¿ƒæµ‹è¯•
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/test/java/com/ming/rpc/registry/`

é¡¹ç›®ä¸ºæ¯ä¸ªæ³¨å†Œä¸­å¿ƒéƒ½æä¾›äº†å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼š

1. **EtcdRegistryTest** - ETCDæ³¨å†Œä¸­å¿ƒæµ‹è¯•
2. **ZooKeeperRegistryTest** - ZooKeeperæ³¨å†Œä¸­å¿ƒæµ‹è¯•
3. **MockRegistryTest** - Mockæ³¨å†Œä¸­å¿ƒæµ‹è¯•

### æµ‹è¯•ç¤ºä¾‹
```java
@Test
public void testRegisterAndDiscover() {
    // Given
    ServiceMetaInfo serviceMetaInfo = new ServiceMetaInfo();
    serviceMetaInfo.setServiceName("testService");
    serviceMetaInfo.setServiceVersion("1.0");
    serviceMetaInfo.setServiceHost("localhost");
    serviceMetaInfo.setServicePort(8080);

    // When
    registry.register(serviceMetaInfo);
    List<ServiceMetaInfo> discoveredServices = registry.serviceDiscovery(serviceMetaInfo.getServiceKey());

    // Then
    assertEquals(1, discoveredServices.size());
    assertEquals(serviceMetaInfo.getServiceName(), discoveredServices.get(0).getServiceName());
}
```
## ğŸ“Š æ³¨å†Œä¸­å¿ƒå¯¹æ¯”

åŸºäºé¡¹ç›®å®é™…æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒå¯¹æ¯”ï¼š

| æ³¨å†Œä¸­å¿ƒ | ä¸€è‡´æ€§æ¨¡å‹ | æ€§èƒ½ | è¿ç»´å¤æ‚åº¦ | ç”Ÿæ€æ”¯æŒ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|------|-----------|----------|----------|
| ETCD    | CP        | é«˜   | ä¸­ç­‰      | å¥½       | é«˜æ€§èƒ½ã€å¼ºä¸€è‡´æ€§ |
| ZooKeeper | CP      | ä¸­ç­‰ | é«˜        | æå¥½     | ä¼ä¸šçº§ã€å¤§æ•°æ® |
| Mock    | -         | æé«˜ | æä½      | -        | æµ‹è¯•ã€å¼€å‘ |
| æ•°æ®åº“  | ACID      | ä½   | ä¸­ç­‰      | å¥½       | æ•°æ®æŒä¹…åŒ– |

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### é…ç½®æ³¨å†Œä¸­å¿ƒ
åœ¨RPCé…ç½®ä¸­æŒ‡å®šæ³¨å†Œä¸­å¿ƒï¼š

```yaml
rpc:
  registry:
    type: etcd  # å¯é€‰: etcd, zookeeper, consul, redis, nacos
    address: http://localhost:2379
    timeout: 10000
    username: ""
    password: ""
```

### ä»£ç ä¸­ä½¿ç”¨
```java
// é€šè¿‡å·¥å‚è·å–æ³¨å†Œä¸­å¿ƒ
Registry registry = RegistryFactory.getInstance(RegistryKeys.ETCD);

// åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒ
RegistryConfig config = new RegistryConfig();
config.setAddress("http://localhost:2379");
registry.init(config);

// æ³¨å†ŒæœåŠ¡
ServiceMetaInfo serviceMetaInfo = new ServiceMetaInfo();
serviceMetaInfo.setServiceName("UserService");
serviceMetaInfo.setServiceHost("localhost");
serviceMetaInfo.setServicePort(8080);
registry.register(serviceMetaInfo);

// å‘ç°æœåŠ¡
List<ServiceMetaInfo> services = registry.serviceDiscovery("UserService:1.0");
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ³¨å†Œä¸­å¿ƒé€‰æ‹©
- **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ETCDæˆ–ZooKeeperï¼Œä¿è¯é«˜å¯ç”¨æ€§
- **å¼€å‘æµ‹è¯•**: ä½¿ç”¨Mockæ³¨å†Œä¸­å¿ƒï¼Œå¿«é€Ÿå¯åŠ¨
- **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨æ•°æ®åº“æ³¨å†Œä¸­å¿ƒï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±
- **å¤§æ•°æ®åœºæ™¯**: ä½¿ç”¨ZooKeeperï¼Œä¸Hadoopç”Ÿæ€é›†æˆ

### 2. æ€§èƒ½ä¼˜åŒ–
- å¯ç”¨æœåŠ¡å‘ç°ç¼“å­˜ï¼Œå‡å°‘æ³¨å†Œä¸­å¿ƒè®¿é—®
- åˆç†è®¾ç½®å¿ƒè·³é—´éš”ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ³¨å†Œä¸­å¿ƒè¿æ¥

### 3. é«˜å¯ç”¨éƒ¨ç½²
- æ³¨å†Œä¸­å¿ƒé›†ç¾¤éƒ¨ç½²ï¼Œé¿å…å•ç‚¹æ•…éšœ
- é…ç½®å¤šä¸ªæ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œå®ç°æ•…éšœè½¬ç§»
- å®šæœŸå¤‡ä»½æ³¨å†Œä¸­å¿ƒæ•°æ®

### 4. ç›‘æ§å’Œè¿ç»´
- ç›‘æ§æ³¨å†Œä¸­å¿ƒçš„å¥åº·çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
- è®°å½•æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„æ“ä½œæ—¥å¿—
- è®¾ç½®å‘Šè­¦æœºåˆ¶ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

## ğŸ“ˆ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ³¨å†Œä¸­å¿ƒ
1. å®ç°`Registry`æ¥å£
2. åœ¨SPIé…ç½®æ–‡ä»¶ä¸­æ³¨å†Œ
3. æ·»åŠ å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
4. æ›´æ–°æ³¨å†Œä¸­å¿ƒå¸¸é‡

### ç¤ºä¾‹ï¼šæ·»åŠ Redisæ³¨å†Œä¸­å¿ƒ
```java
public class RedisRegistry implements Registry {
    @Override
    public void init(RegistryConfig registryConfig) {
        // Redisæ³¨å†Œä¸­å¿ƒåˆå§‹åŒ–
    }

    @Override
    public void register(ServiceMetaInfo serviceMetaInfo) throws Exception {
        // Redisæ³¨å†Œä¸­å¿ƒæ³¨å†Œå®ç°
    }

    @Override
    public List<ServiceMetaInfo> serviceDiscovery(String serviceKey) {
        // Redisæ³¨å†Œä¸­å¿ƒæœåŠ¡å‘ç°å®ç°
    }
}
```

## ğŸ“‹ æ€»ç»“

Ming RPC Frameworkçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ï¼Œæä¾›äº†å®Œæ•´ã€å¯é çš„æœåŠ¡æ³¨å†Œä¸å‘ç°è§£å†³æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **å¤šç§æ³¨å†Œä¸­å¿ƒæ”¯æŒ**: ETCDã€ZooKeeperã€Mockã€æ•°æ®åº“ç­‰å¤šç§å®ç°
- âœ… **SPIæœºåˆ¶æ‰©å±•**: é€šè¿‡SPIæœºåˆ¶å®ç°æ³¨å†Œä¸­å¿ƒçš„åŠ¨æ€åŠ è½½å’Œæ‰©å±•
- âœ… **å·¥å‚æ¨¡å¼ç®¡ç†**: ç»Ÿä¸€çš„æ³¨å†Œä¸­å¿ƒå·¥å‚ç®¡ç†å’Œåˆ›å»º
- âœ… **å®Œå–„çš„æµ‹è¯•**: æ¯ä¸ªæ³¨å†Œä¸­å¿ƒéƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯
- âœ… **åœºæ™¯é€‚é…**: é’ˆå¯¹ä¸åŒåœºæ™¯æä¾›æœ€ä¼˜çš„æ³¨å†Œä¸­å¿ƒé€‰æ‹©

### æŠ€æœ¯ç‰¹è‰²
- **å¯æ’æ‹”è®¾è®¡**: é€šè¿‡æ¥å£æŠ½è±¡å’ŒSPIæœºåˆ¶å®ç°å¯æ’æ‹”
- **æœåŠ¡ç¼“å­˜**: æ”¯æŒå¤šæœåŠ¡ç¼“å­˜ï¼Œæé«˜æœåŠ¡å‘ç°æ€§èƒ½
- **å¿ƒè·³æœºåˆ¶**: è‡ªåŠ¨å¿ƒè·³ç»­çº¦ï¼Œä¿è¯æœåŠ¡å®ä¾‹çš„å®æ—¶æ€§
- **ç›‘å¬æœºåˆ¶**: æ”¯æŒæœåŠ¡å˜æ›´ç›‘å¬ï¼Œå®æ—¶æ„ŸçŸ¥æœåŠ¡çŠ¶æ€

Ming RPC Frameworkçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒä¸ºåˆ†å¸ƒå¼RPCè°ƒç”¨æä¾›äº†å¼ºæœ‰åŠ›çš„åŸºç¡€è®¾æ–½æ”¯æ’‘ï¼Œç¡®ä¿äº†æœåŠ¡çš„å¯å‘ç°æ€§å’Œé«˜å¯ç”¨æ€§ã€‚