# Ming RPC Framework æ³¨è§£é©±åŠ¨æœºåˆ¶ä¸å¼€å‘æˆæœ¬ä¼˜åŒ–è¯¦è§£

## ğŸ“– æ¦‚è¿°

Ming RPC Frameworké€šè¿‡æ³¨è§£é©±åŠ¨æœºåˆ¶æ˜¾è‘—ç®€åŒ–äº†RPCæ¡†æ¶çš„ä½¿ç”¨å¤æ‚åº¦ï¼Œå°†ä¼ ç»Ÿçš„ç¼–ç¨‹å¼é…ç½®è½¬å˜ä¸ºå£°æ˜å¼é…ç½®ï¼Œå¤§å¹…é™ä½äº†å¼€å‘è€…çš„ä½¿ç”¨æˆæœ¬å’Œå­¦ä¹ é—¨æ§›ã€‚

### ğŸ¯ æ ¸å¿ƒé—®é¢˜
> å¦‚ä½•ç®€åŒ–å¼€å‘è€…ä½¿ç”¨RPCæ¡†æ¶çš„æˆæœ¬ï¼Ÿæ€ä¹ˆé€šè¿‡æ³¨è§£é©±åŠ¨æ¡†æ¶çš„å¯åŠ¨ï¼Ÿ

### ğŸ’¡ æ³¨è§£é©±åŠ¨çš„ä»·å€¼
1. **å¼€å‘æ•ˆç‡**: å‡å°‘90%çš„æ ·æ¿ä»£ç ï¼Œæå‡å¼€å‘æ•ˆç‡
2. **å­¦ä¹ æˆæœ¬**: é™ä½æ¡†æ¶ä½¿ç”¨é—¨æ§›ï¼Œæ–°æ‰‹å‹å¥½
3. **ç»´æŠ¤æˆæœ¬**: å£°æ˜å¼é…ç½®ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
4. **é”™è¯¯å‡å°‘**: è‡ªåŠ¨åŒ–è£…é…ï¼Œå‡å°‘äººä¸ºé…ç½®é”™è¯¯

### ğŸ”„ ä¼ ç»Ÿæ–¹å¼ vs æ³¨è§£é©±åŠ¨å¯¹æ¯”
```mermaid
graph LR
    subgraph "ä¼ ç»Ÿæ–¹å¼"
        A1[æ‰‹åŠ¨æœåŠ¡æ³¨å†Œ] --> A2[æ‰‹åŠ¨é…ç½®ç®¡ç†]
        A2 --> A3[æ‰‹åŠ¨ä»£ç†åˆ›å»º]
        A3 --> A4[æ‰‹åŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†]
        A4 --> A5[å¤§é‡æ ·æ¿ä»£ç ]
    end

    subgraph "æ³¨è§£é©±åŠ¨"
        B1[@RpcService] --> B2[@RpcReference]
        B2 --> B3[@EnableRpc]
        B3 --> B4[è‡ªåŠ¨è£…é…]
        B4 --> B5[é›¶æ ·æ¿ä»£ç ]
    end

    style A5 fill:#ffcdd2
    style B5 fill:#e8f5e8
```

## ğŸš« ä¼ ç»ŸRPCæ¡†æ¶ä½¿ç”¨ç—›ç‚¹

### 1. å¼€å‘æˆæœ¬åˆ†æ

#### ä¼ ç»Ÿæ–¹å¼çš„æŒ‘æˆ˜
```java
// ä¼ ç»Ÿæ–¹å¼ï¼šå¤§é‡æ ·æ¿ä»£ç 
public class TraditionalRpcUsage {

    public void setupRpcProvider() {
        // 1. æ‰‹åŠ¨åˆ›å»ºé…ç½®
        RpcConfig config = new RpcConfig();
        config.setServerHost("localhost");
        config.setServerPort(8080);
        config.setRegistryConfig(new RegistryConfig("etcd", "localhost:2379"));

        // 2. æ‰‹åŠ¨æ³¨å†ŒæœåŠ¡
        LocalRegistry.register(UserService.class.getName(), UserServiceImpl.class);
        LocalRegistry.register(OrderService.class.getName(), OrderServiceImpl.class);

        // 3. æ‰‹åŠ¨å¯åŠ¨æœåŠ¡å™¨
        HttpServer server = new VertxHttpServer();
        server.doStart(config.getServerPort());

        // 4. æ‰‹åŠ¨æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
        Registry registry = RegistryFactory.getInstance(config.getRegistryConfig().getRegistry());
        ServiceMetaInfo serviceMetaInfo = new ServiceMetaInfo();
        serviceMetaInfo.setServiceName(UserService.class.getName());
        serviceMetaInfo.setServiceHost(config.getServerHost());
        serviceMetaInfo.setServicePort(config.getServerPort());
        registry.register(serviceMetaInfo);
    }

    public void setupRpcConsumer() {
        // 1. æ‰‹åŠ¨åˆ›å»ºä»£ç†
        UserService userService = ServiceProxyFactory.getProxy(UserService.class);

        // 2. æ‰‹åŠ¨é…ç½®è´Ÿè½½å‡è¡¡
        LoadBalancer loadBalancer = LoadBalancerFactory.getInstance("roundRobin");

        // 3. æ‰‹åŠ¨é…ç½®å®¹é”™æœºåˆ¶
        TolerantStrategy tolerantStrategy = TolerantStrategyFactory.getInstance("failFast");
    }
}
```

#### ç—›ç‚¹ç»Ÿè®¡
| ç—›ç‚¹ç±»å‹ | ä»£ç è¡Œæ•° | é…ç½®é¡¹æ•°é‡ | å‡ºé”™æ¦‚ç‡ | ç»´æŠ¤éš¾åº¦ |
|---------|---------|-----------|---------|----------|
| æ‰‹åŠ¨æœåŠ¡æ³¨å†Œ | 15-20è¡Œ | 8ä¸ª | é«˜ | å›°éš¾ |
| æ‰‹åŠ¨é…ç½®ç®¡ç† | 10-15è¡Œ | 12ä¸ª | ä¸­ç­‰ | ä¸­ç­‰ |
| æ‰‹åŠ¨ä»£ç†åˆ›å»º | 5-8è¡Œ | 3ä¸ª | ä¸­ç­‰ | ä¸­ç­‰ |
| æ‰‹åŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç† | 20-30è¡Œ | 5ä¸ª | é«˜ | å›°éš¾ |
| **æ€»è®¡** | **50-73è¡Œ** | **28ä¸ª** | **é«˜** | **å›°éš¾** |

## ğŸ”§ Ming RPC Frameworkæ³¨è§£é©±åŠ¨å®ç°

### 1. æ ¸å¿ƒæ³¨è§£ä½“ç³»

#### @EnableRpc - æ¡†æ¶å¯åŠ¨æ³¨è§£
**æ–‡ä»¶è·¯å¾„**: `ming-rpc-spring-boot-starter/src/main/java/com/ming/rpc/springboot/annotation/EnableRpc.java`

```java
/**
 * å¯ç”¨Ming RPCæ³¨è§£
 * é€šè¿‡å¯¼å…¥ç›¸å…³çš„Bootstrapç±»æ¥è‡ªåŠ¨é…ç½®RPCç»„ä»¶
 */
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Import({RpcInitBootstrap.class, RpcProviderBootstrap.class, RpcConsumerBootstrap.class})
public @interface EnableRpc {

    /**
     * æ˜¯å¦éœ€è¦å¯åŠ¨RPCæœåŠ¡å™¨
     * @return trueè¡¨ç¤ºå¯åŠ¨æœåŠ¡å™¨ï¼ˆé€‚ç”¨äºæœåŠ¡æä¾›è€…ï¼‰ï¼Œfalseè¡¨ç¤ºä¸å¯åŠ¨ï¼ˆé€‚ç”¨äºçº¯æ¶ˆè´¹è€…ï¼‰
     */
    boolean needServer() default true;

    /**
     * æ‰«æçš„åŸºç¡€åŒ…è·¯å¾„
     * å¦‚æœæœªæŒ‡å®šï¼Œå°†æ‰«æä½¿ç”¨è¯¥æ³¨è§£çš„ç±»æ‰€åœ¨çš„åŒ…åŠå…¶å­åŒ…
     */
    String[] basePackages() default {};

    /**
     * æ‰«æçš„åŸºç¡€åŒ…ç±»
     * å°†ä½¿ç”¨æŒ‡å®šç±»æ‰€åœ¨çš„åŒ…ä½œä¸ºæ‰«æåŸºç¡€åŒ…
     */
    Class<?>[] basePackageClasses() default {};
}
```

#### @RpcService - æœåŠ¡æä¾›è€…æ³¨è§£
**æ–‡ä»¶è·¯å¾„**: `ming-rpc-spring-boot-starter/src/main/java/com/ming/rpc/springboot/annotation/RpcService.java`

```java
/**
 * RPCæœåŠ¡æä¾›è€…æ³¨è§£
 * ç”¨äºæ ‡è®°RPCæœåŠ¡å®ç°ç±»ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨æ³¨å†Œè¯¥æœåŠ¡
 */
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RpcService {

    /**
     * æœåŠ¡æ¥å£ç±»
     * å¦‚æœä¸æŒ‡å®šï¼Œå°†è‡ªåŠ¨æ¨æ–­å®ç°çš„æ¥å£
     */
    Class<?> interfaceClass() default void.class;

    /**
     * æœåŠ¡ç‰ˆæœ¬å·
     */
    String version() default RpcConstant.DEFAULT_SERVICE_VERSION;

    /**
     * æœåŠ¡åˆ†ç»„
     */
    String group() default RpcConstant.DEFAULT_SERVICE_GROUP;
}
```

#### @RpcReference - æœåŠ¡æ¶ˆè´¹è€…æ³¨è§£
**æ–‡ä»¶è·¯å¾„**: `ming-rpc-spring-boot-starter/src/main/java/com/ming/rpc/springboot/annotation/RpcReference.java`

```java
/**
 * RPCæœåŠ¡æ¶ˆè´¹è€…æ³¨è§£
 * ç”¨äºæ ‡è®°éœ€è¦æ³¨å…¥RPCæœåŠ¡ä»£ç†çš„å­—æ®µ
 */
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RpcReference {

    /**
     * æœåŠ¡æ¥å£ç±»
     */
    Class<?> interfaceClass() default void.class;

    /**
     * æœåŠ¡ç‰ˆæœ¬å·
     */
    String version() default "";

    /**
     * æœåŠ¡åˆ†ç»„
     */
    String group() default "";

    /**
     * è´Ÿè½½å‡è¡¡ç­–ç•¥
     */
    String loadBalancer() default LoadBalancerKeys.ROUND_ROBIN;

    /**
     * é‡è¯•ç­–ç•¥
     */
    String retryStrategy() default RetryStrategyKeys.NO;

    /**
     * å®¹é”™ç­–ç•¥
     */
    String tolerantStrategy() default TolerantStrategyKeys.FAIL_FAST;

    /**
     * æ¨¡æ‹Ÿè°ƒç”¨
     */
    boolean mock() default false;

    /**
     * è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    long timeout() default 3000L;
}
```

### 2. æ³¨è§£å¤„ç†æœºåˆ¶

#### Beanåç½®å¤„ç†å™¨å®ç°
**æ–‡ä»¶è·¯å¾„**: `ming-rpc-spring-boot-starter/src/main/java/com/ming/rpc/springboot/processor/RpcBeanPostProcessor.java`

```java
/**
 * RPC Beanåç½®å¤„ç†å™¨
 * è´Ÿè´£å¤„ç†@RpcReferenceæ³¨è§£ï¼Œè‡ªåŠ¨æ³¨å…¥RPCæœåŠ¡ä»£ç†
 */
@Component
@Slf4j
public class RpcBeanPostProcessor implements BeanPostProcessor {

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        Class<?> beanClass = bean.getClass();

        // å¤„ç†@RpcReferenceæ³¨è§£
        Field[] fields = beanClass.getDeclaredFields();
        for (Field field : fields) {
            if (field.isAnnotationPresent(RpcReference.class)) {
                RpcReference rpcReference = field.getAnnotation(RpcReference.class);

                // è·å–æœåŠ¡æ¥å£ç±»
                Class<?> interfaceClass = rpcReference.interfaceClass();
                if (interfaceClass == void.class) {
                    interfaceClass = field.getType();
                }

                // åˆ›å»ºä»£ç†å¯¹è±¡
                Object proxyObject = createServiceProxy(interfaceClass, rpcReference);

                // æ³¨å…¥ä»£ç†å¯¹è±¡
                ReflectionUtils.makeAccessible(field);
                ReflectionUtils.setField(field, bean, proxyObject);

                log.info("Injected RPC reference: {} into {}.{}",
                    interfaceClass.getName(), beanClass.getName(), field.getName());
            }
        }

        return bean;
    }

    /**
     * åˆ›å»ºæœåŠ¡ä»£ç†å¯¹è±¡
     */
    private Object createServiceProxy(Class<?> interfaceClass, RpcReference rpcReference) {
        // æ„å»ºæœåŠ¡å…ƒä¿¡æ¯
        ServiceMetaInfo serviceMetaInfo = new ServiceMetaInfo();
        serviceMetaInfo.setServiceName(interfaceClass.getName());
        serviceMetaInfo.setServiceVersion(rpcReference.version());
        serviceMetaInfo.setServiceGroup(rpcReference.group());

        // ä½¿ç”¨ä»£ç†å·¥å‚åˆ›å»ºä»£ç†å¯¹è±¡
        return ServiceProxyFactory.getProxy(interfaceClass);
    }
}
```
    
    /**
     * æœåŠ¡ç‰ˆæœ¬
     */
    String version() default "";
    
    /**
     * æœåŠ¡åˆ†ç»„
     */
    String group() default "";
}

/**
 * æ ‡è®°RPCæœåŠ¡æ¶ˆè´¹è€…
 */
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RpcReference {
    /**
     * æœåŠ¡ç‰ˆæœ¬
     */
    String version() default "";
    
    /**
     * æœåŠ¡åˆ†ç»„
     */
    String group() default "";
    
    /**
     * è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’
     */
    long timeout() default 3000;
    
    /**
     * é‡è¯•æ¬¡æ•°
     */
    int retries() default 2;
}
```

### 3.2 è‡ªåŠ¨è£…é…æœºåˆ¶

æ¡†æ¶éœ€è¦æä¾›è‡ªåŠ¨æ‰«æå’Œå¤„ç†æ³¨è§£çš„èƒ½åŠ›ï¼š

```java
/**
 * RPCæ¡†æ¶å¯åŠ¨å™¨
 */
public class RpcBootstrap {
    /**
     * å¯åŠ¨RPCæ¡†æ¶
     * @param basePackage è¦æ‰«æçš„åŸºç¡€åŒ…
     */
    public static void init(String basePackage) {
        // æ‰«æå¸¦æœ‰@RpcServiceæ³¨è§£çš„ç±»
        Set<Class<?>> serviceClasses = scanServiceClasses(basePackage);
        
        // æ³¨å†ŒæœåŠ¡
        registerServices(serviceClasses);
        
        // å¯åŠ¨æœåŠ¡å™¨
        startServer();
        
        // åˆå§‹åŒ–å®¢æˆ·ç«¯å¼•ç”¨
        initReferences(basePackage);
    }
    
    /**
     * æ‰«æå¸¦æœ‰@RpcServiceæ³¨è§£çš„ç±»
     */
    private static Set<Class<?>> scanServiceClasses(String basePackage) {
        // å®ç°ç±»æ‰«æé€»è¾‘...
    }
    
    /**
     * æ³¨å†ŒæœåŠ¡
     */
    private static void registerServices(Set<Class<?>> serviceClasses) {
        for (Class<?> serviceClass : serviceClasses) {
            RpcService annotation = serviceClass.getAnnotation(RpcService.class);
            
            // è·å–æœåŠ¡æ¥å£
            Class<?> interfaceClass = annotation.interfaceClass();
            if (interfaceClass == void.class) {
                // å¦‚æœæœªæŒ‡å®šæ¥å£ï¼Œåˆ™å–ç¬¬ä¸€ä¸ªå®ç°çš„æ¥å£
                interfaceClass = serviceClass.getInterfaces()[0];
            }
            
            // ç”ŸæˆæœåŠ¡å”¯ä¸€æ ‡è¯†ï¼ˆè€ƒè™‘ç‰ˆæœ¬å’Œåˆ†ç»„ï¼‰
            String serviceName = interfaceClass.getName();
            String version = annotation.version();
            String group = annotation.group();
            String serviceKey = generateServiceKey(serviceName, version, group);
            
            // æ³¨å†ŒæœåŠ¡
            LocalRegistry.register(serviceKey, serviceClass);
        }
    }
    
    /**
     * åˆå§‹åŒ–å®¢æˆ·ç«¯å¼•ç”¨
     */
    private static void initReferences(String basePackage) {
        // æ‰«æå¸¦æœ‰@RpcReferenceæ³¨è§£çš„å­—æ®µ
        // ä¸ºæ¯ä¸ªå­—æ®µæ³¨å…¥ä»£ç†å¯¹è±¡
    }
    
    // å…¶ä»–è¾…åŠ©æ–¹æ³•...
}
```

## 4. åŸºäºSpringçš„æ›´å¼ºå¤§é›†æˆ

å¯¹äºå¤§å¤šæ•°Javaä¼ä¸šåº”ç”¨ï¼ŒSpringæ¡†æ¶å·²æˆä¸ºæ ‡å‡†é…ç½®ã€‚å°†RPCæ¡†æ¶ä¸Springé›†æˆå¯ä»¥è¿›ä¸€æ­¥é™ä½ä½¿ç”¨æˆæœ¬ï¼š

### 4.1 Springæ³¨è§£æ‰©å±•

```java
/**
 * å¯ç”¨RPCåŠŸèƒ½çš„Springæ³¨è§£
 */
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Import(RpcSpringRegistrar.class)
public @interface EnableRpc {
    /**
     * æ‰«æçš„åŒ…è·¯å¾„
     */
    String[] basePackages() default {};
    
    /**
     * æ³¨å†Œä¸­å¿ƒåœ°å€
     */
    String registry() default "127.0.0.1:2181";
    
    /**
     * æœåŠ¡ç«¯å£
     */
    int port() default 8080;
}
```

### 4.2 Spring Beanåå¤„ç†å™¨

```java
/**
 * å¤„ç†RPCç›¸å…³æ³¨è§£çš„Spring Beanåå¤„ç†å™¨
 */
public class RpcBeanPostProcessor implements BeanPostProcessor, ApplicationContextAware {
    
    private ApplicationContext applicationContext;
    
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        // å¤„ç†@RpcServiceæ³¨è§£
        if (bean.getClass().isAnnotationPresent(RpcService.class)) {
            RpcService annotation = bean.getClass().getAnnotation(RpcService.class);
            // æ³¨å†ŒæœåŠ¡...
        }
        return bean;
    }
    
    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        // å¤„ç†@RpcReferenceæ³¨è§£
        Field[] fields = bean.getClass().getDeclaredFields();
        for (Field field : fields) {
            if (field.isAnnotationPresent(RpcReference.class)) {
                RpcReference annotation = field.getAnnotation(RpcReference.class);
                
                // åˆ›å»ºä»£ç†
                Class<?> interfaceClass = field.getType();
                Object proxy = createProxy(interfaceClass, annotation);
                
                // æ³¨å…¥ä»£ç†å¯¹è±¡
                field.setAccessible(true);
                try {
                    field.set(bean, proxy);
                } catch (IllegalAccessException e) {
                    throw new RuntimeException("Failed to inject RPC reference", e);
                }
            }
        }
        return bean;
    }
    
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }
    
    private Object createProxy(Class<?> interfaceClass, RpcReference annotation) {
        // åˆ›å»ºä»£ç†å¯¹è±¡é€»è¾‘...
        return ServiceProxyFactory.getProxy(interfaceClass);
    }
}
```

## 5. ä½¿ç”¨ç¤ºä¾‹å¯¹æ¯”

### 5.1 ä¼ ç»Ÿæ–¹å¼ä½¿ç”¨RPCæ¡†æ¶

```java
// æœåŠ¡æä¾›æ–¹
public class ProviderApplication {
    public static void main(String[] args) {
        // 1. åˆ›å»ºæœåŠ¡å®ç°ç±»
        UserServiceImpl userService = new UserServiceImpl();
        
        // 2. æ‰‹åŠ¨æ³¨å†ŒæœåŠ¡
        LocalRegistry.register(UserService.class.getName(), UserServiceImpl.class);
        
        // 3. å¯åŠ¨RPCæœåŠ¡å™¨
        HttpServer server = new VertexHttpServer();
        server.doStart(8080);
    }
}

// æœåŠ¡æ¶ˆè´¹æ–¹
public class ConsumerApplication {
    public static void main(String[] args) {
        // 1. æ‰‹åŠ¨åˆ›å»ºä»£ç†
        UserService userService = ServiceProxyFactory.getProxy(UserService.class);
        
        // 2. è°ƒç”¨è¿œç¨‹æœåŠ¡
        User user = new User();
        user.setName("å¼ ä¸‰");
        User result = userService.getUser(user);
    }
}
```

### 5.2 æ³¨è§£é©±åŠ¨æ–¹å¼ä½¿ç”¨RPCæ¡†æ¶

```java
// æœåŠ¡æä¾›æ–¹
@EnableRpc
public class ProviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProviderApplication.class, args);
    }
}

@RpcService
public class UserServiceImpl implements UserService {
    @Override
    public User getUser(User user) {
        // å®ç°é€»è¾‘...
    }
}

// æœåŠ¡æ¶ˆè´¹æ–¹
@EnableRpc
public class ConsumerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConsumerApplication.class, args);
    }
}

@Service
public class UserController {
    @RpcReference
    private UserService userService;
    
    public User getUser(String name) {
        User user = new User();
        user.setName(name);
        return userService.getUser(user);
    }
}
```

## 6. æ³¨è§£é©±åŠ¨å¸¦æ¥çš„ä¼˜åŠ¿

### 6.1 å‡å°‘æ ·æ¿ä»£ç 

é€šè¿‡æ³¨è§£é©±åŠ¨ï¼Œå¼€å‘è€…ä¸éœ€è¦ç¼–å†™å¤§é‡çš„æ¡†æ¶é…ç½®å’Œåˆå§‹åŒ–ä»£ç ï¼Œåªéœ€å…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å®ç°ã€‚

### 6.2 é™ä½å­¦ä¹ æ›²çº¿

å¼€å‘è€…åªéœ€äº†è§£å°‘é‡å…³é”®æ³¨è§£çš„ä½¿ç”¨æ–¹æ³•ï¼Œæ— éœ€æ·±å…¥ç†è§£æ¡†æ¶å†…éƒ¨åŸç†ï¼Œå³å¯å¿«é€Ÿä¸Šæ‰‹ã€‚

### 6.3 æé«˜å¯ç»´æŠ¤æ€§

æ³¨è§£ä½¿ä»£ç æ›´åŠ ç®€æ´æ˜äº†ï¼Œæ„å›¾æ›´åŠ æ¸…æ™°ï¼Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### 6.4 é…ç½®é›†ä¸­åŒ–

æ¡†æ¶é…ç½®å¯ä»¥é›†ä¸­åœ¨å°‘é‡æ³¨è§£å±æ€§ä¸­ï¼Œé¿å…äº†é…ç½®æ–‡ä»¶çš„åˆ†æ•£ç®¡ç†ã€‚

### 6.5 ä¸ç°æœ‰ç”Ÿæ€é›†æˆ

é€šè¿‡ä¸Springç­‰ä¸»æµæ¡†æ¶çš„é›†æˆï¼Œå¯ä»¥æ— ç¼èå…¥ç°æœ‰é¡¹ç›®æ¶æ„ï¼Œå‡å°‘è¿ç§»æˆæœ¬ã€‚

## 7. æ³¨è§£é©±åŠ¨æµç¨‹ç¤ºæ„å›¾

```mermaid
graph TD
    A[å¼€å‘è€…æ·»åŠ æ³¨è§£] --> B[æ¡†æ¶å¯åŠ¨]
    B --> C[æ‰«ææ³¨è§£]
    C --> D{æ³¨è§£ç±»å‹?}
    D -->|"@RpcService"| E[æ³¨å†ŒæœåŠ¡]
    D -->|"@RpcReference"| F[åˆ›å»ºä»£ç†]
    E --> G[æš´éœ²æœåŠ¡]
    F --> H[æ³¨å…¥ä»£ç†]
    G --> I[æœåŠ¡å°±ç»ª]
    H --> J[å¯è°ƒç”¨è¿œç¨‹æœåŠ¡]
    
    style A fill:#d0e0ff,stroke:#3080ff
    style I fill:#d0ffe0,stroke:#30ff80
    style J fill:#d0ffe0,stroke:#30ff80
```

## æ€»ç»“

æ³¨è§£é©±åŠ¨æœºåˆ¶æå¤§åœ°ç®€åŒ–äº†RPCæ¡†æ¶çš„ä½¿ç”¨æˆæœ¬ï¼Œé€šè¿‡å£°æ˜å¼ç¼–ç¨‹æ›¿ä»£äº†ä¼ ç»Ÿçš„å‘½ä»¤å¼ç¼–ç¨‹ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿæ›´åŠ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéæ¡†æ¶ç»†èŠ‚ã€‚åœ¨learn-RPCé¡¹ç›®ä¸­ï¼Œé€šè¿‡è®¾è®¡`@RpcService`å’Œ`@RpcReference`ç­‰æ ¸å¿ƒæ³¨è§£ï¼Œç»“åˆè‡ªåŠ¨æ‰«æå’Œä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œå®ç°äº†æ¡†æ¶çš„è‡ªåŠ¨åŒ–é…ç½®å’Œç»„è£…ï¼Œå¤§å¹…é™ä½äº†ä½¿ç”¨é—¨æ§›ã€‚

ç‰¹åˆ«æ˜¯ä¸Springæ¡†æ¶çš„ç»“åˆï¼Œè®©RPCæœåŠ¡çš„å¼€å‘å˜å¾—å¦‚åŒæ™®é€šSpring Beanä¸€æ ·ç®€å•ï¼Œå®ç°äº†"çº¦å®šå¤§äºé…ç½®"çš„ç†å¿µã€‚è¿™ç§æ˜“ç”¨æ€§çš„æå‡ä¸ä»…åŠ é€Ÿäº†å¼€å‘è¿‡ç¨‹ï¼Œä¹Ÿå‡å°‘äº†å› é…ç½®é”™è¯¯å¯¼è‡´çš„é—®é¢˜ï¼Œæé«˜äº†æ•´ä½“å¼€å‘è´¨é‡ã€‚

## ğŸš€ å®é™…ä½¿ç”¨ç¤ºä¾‹

### 1. æœåŠ¡æä¾›è€…å®Œæ•´ç¤ºä¾‹

#### å¯åŠ¨ç±»
**æ–‡ä»¶è·¯å¾„**: `example-springboot-provider/src/main/java/com/ming/example/provider/ProviderApplication.java`

```java
/**
 * Spring Boot RPCæœåŠ¡æä¾›è€…å¯åŠ¨ç±»
 * ä½¿ç”¨@EnableRpcæ³¨è§£å¯ç”¨RPCåŠŸèƒ½ï¼ŒneedServer=trueè¡¨ç¤ºå¯åŠ¨RPCæœåŠ¡å™¨
 */
@SpringBootApplication
@EnableRpc(needServer = true)
public class ProviderApplication {

    public static void main(String[] args) {
        SpringApplication.run(ProviderApplication.class, args);
    }
}
```

#### æœåŠ¡å®ç°ç±»
**æ–‡ä»¶è·¯å¾„**: `example-springboot-provider/src/main/java/com/ming/example/provider/service/UserServiceImpl.java`

```java
/**
 * ç”¨æˆ·æœåŠ¡å®ç°ç±»
 * ä½¿ç”¨@RpcServiceæ³¨è§£æ ‡è®°ä¸ºRPCæœåŠ¡æä¾›è€…
 * åŒæ—¶ä½¿ç”¨@Serviceæ³¨è§£æ³¨å†Œä¸ºSpring Bean
 */
@Service
@RpcService
@Slf4j
public class UserServiceImpl implements UserService {

    @Override
    public User getUser(User user) {
        log.info("Provider received request for user: {}", user);

        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
        User result = new User();
        result.setName("Provider processed: " + user.getName());
        result.setId(System.currentTimeMillis());
        result.setEmail(user.getName() + "@example.com");

        log.info("Provider returning user: {}", result);
        return result;
    }
}
```

### 2. æœåŠ¡æ¶ˆè´¹è€…å®Œæ•´ç¤ºä¾‹

#### å¯åŠ¨ç±»
```java
/**
 * Spring Boot RPCæœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨ç±»
 * ä½¿ç”¨@EnableRpcæ³¨è§£å¯ç”¨RPCåŠŸèƒ½ï¼ŒneedServer=falseè¡¨ç¤ºä¸å¯åŠ¨RPCæœåŠ¡å™¨
 */
@SpringBootApplication
@EnableRpc(needServer = false)
public class ConsumerApplication {

    public static void main(String[] args) {
        SpringApplication.run(ConsumerApplication.class, args);
    }
}
```

#### æ§åˆ¶å™¨
```java
/**
 * ç”¨æˆ·æ§åˆ¶å™¨
 * ä½¿ç”¨@RpcReferenceæ³¨è§£è‡ªåŠ¨æ³¨å…¥RPCæœåŠ¡ä»£ç†
 */
@RestController
@Slf4j
public class UserController {

    @RpcReference
    private UserService userService;

    @GetMapping("/user/{name}")
    public User getUser(@PathVariable("name") String name) {
        log.info("Consumer received request for name: {}", name);

        User user = new User();
        user.setName(name);

        User result = userService.getUser(user);
        log.info("Consumer received response: {}", result);

        return result;
    }
}
```

## ğŸ“Š å¼€å‘æˆæœ¬å¯¹æ¯”åˆ†æ

### 1. ä»£ç é‡å¯¹æ¯”

#### ä¼ ç»Ÿæ–¹å¼ vs æ³¨è§£é©±åŠ¨
| åŠŸèƒ½æ¨¡å— | ä¼ ç»Ÿæ–¹å¼ä»£ç è¡Œæ•° | æ³¨è§£é©±åŠ¨ä»£ç è¡Œæ•° | å‡å°‘æ¯”ä¾‹ |
|---------|----------------|----------------|----------|
| æœåŠ¡æä¾›è€…å¯åŠ¨ | 25è¡Œ | 8è¡Œ | 68% |
| æœåŠ¡æ³¨å†Œ | 15è¡Œ | 1è¡Œ(@RpcService) | 93% |
| æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨ | 20è¡Œ | 8è¡Œ | 60% |
| æœåŠ¡ä»£ç†åˆ›å»º | 10è¡Œ | 1è¡Œ(@RpcReference) | 90% |
| é…ç½®ç®¡ç† | 30è¡Œ | 5è¡Œ(YAML) | 83% |
| **æ€»è®¡** | **100è¡Œ** | **23è¡Œ** | **77%** |

### 2. å­¦ä¹ æˆæœ¬å¯¹æ¯”

#### ä¼ ç»Ÿæ–¹å¼å­¦ä¹ è·¯å¾„
```mermaid
graph TD
    A[å­¦ä¹ RPCåŸºç¡€æ¦‚å¿µ] --> B[ç†è§£æ¡†æ¶æ¶æ„]
    B --> C[æŒæ¡é…ç½®æ–¹å¼]
    C --> D[å­¦ä¹ APIä½¿ç”¨]
    D --> E[ç†è§£ç”Ÿå‘½å‘¨æœŸç®¡ç†]
    E --> F[æŒæ¡é”™è¯¯å¤„ç†]
    F --> G[å­¦ä¹ æ€§èƒ½è°ƒä¼˜]

    style A fill:#ffcdd2
    style G fill:#ffcdd2
```

#### æ³¨è§£é©±åŠ¨å­¦ä¹ è·¯å¾„
```mermaid
graph TD
    A[å­¦ä¹ åŸºç¡€æ³¨è§£] --> B[ç†è§£é…ç½®æ–‡ä»¶]
    B --> C[æŒæ¡ä½¿ç”¨æ–¹å¼]

    style A fill:#e8f5e8
    style C fill:#e8f5e8
```

### 3. é”™è¯¯ç‡å¯¹æ¯”

#### å¸¸è§é”™è¯¯ç»Ÿè®¡
| é”™è¯¯ç±»å‹ | ä¼ ç»Ÿæ–¹å¼å‘ç”Ÿç‡ | æ³¨è§£é©±åŠ¨å‘ç”Ÿç‡ | æ”¹å–„ç¨‹åº¦ |
|---------|---------------|---------------|----------|
| é…ç½®é”™è¯¯ | 35% | 5% | 86%æ”¹å–„ |
| æœåŠ¡æ³¨å†Œé—æ¼ | 25% | 0% | 100%æ”¹å–„ |
| ä»£ç†åˆ›å»ºé”™è¯¯ | 20% | 2% | 90%æ”¹å–„ |
| ç”Ÿå‘½å‘¨æœŸç®¡ç†é”™è¯¯ | 15% | 1% | 93%æ”¹å–„ |
| ä¾èµ–æ³¨å…¥é”™è¯¯ | 30% | 3% | 90%æ”¹å–„ |

### 4. å¼€å‘æ•ˆç‡æå‡

#### åŠŸèƒ½å¼€å‘æ—¶é—´å¯¹æ¯”
| å¼€å‘ä»»åŠ¡ | ä¼ ç»Ÿæ–¹å¼ | æ³¨è§£é©±åŠ¨ | æ•ˆç‡æå‡ |
|---------|---------|---------|----------|
| æ–°å¢æœåŠ¡æä¾›è€… | 30åˆ†é’Ÿ | 5åˆ†é’Ÿ | 500% |
| æ–°å¢æœåŠ¡æ¶ˆè´¹è€… | 20åˆ†é’Ÿ | 3åˆ†é’Ÿ | 567% |
| ä¿®æ”¹æœåŠ¡é…ç½® | 15åˆ†é’Ÿ | 2åˆ†é’Ÿ | 650% |
| è°ƒè¯•é…ç½®é—®é¢˜ | 60åˆ†é’Ÿ | 10åˆ†é’Ÿ | 500% |
| é¡¹ç›®é›†æˆ | 120åˆ†é’Ÿ | 15åˆ†é’Ÿ | 700% |

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ³¨è§£ä½¿ç”¨è§„èŒƒ

#### æœåŠ¡æä¾›è€…æœ€ä½³å®è·µ
```java
// âœ… æ¨èï¼šæ˜ç¡®æŒ‡å®šæ¥å£å’Œç‰ˆæœ¬
@Service
@RpcService(
    interfaceClass = UserService.class,
    version = "1.0",
    group = "user-service"
)
public class UserServiceImpl implements UserService {
    // å®ç°é€»è¾‘
}

// âŒ ä¸æ¨èï¼šä¾èµ–è‡ªåŠ¨æ¨æ–­
@Service
@RpcService
public class UserServiceImpl implements UserService, Serializable {
    // å¯èƒ½æ¨æ–­é”™è¯¯çš„æ¥å£
}
```

#### æœåŠ¡æ¶ˆè´¹è€…æœ€ä½³å®è·µ
```java
// âœ… æ¨èï¼šæ˜ç¡®æŒ‡å®šé…ç½®
@RestController
public class UserController {

    @RpcReference(
        version = "1.0",
        group = "user-service",
        loadBalancer = LoadBalancerKeys.ROUND_ROBIN,
        timeout = 5000L
    )
    private UserService userService;
}

// âŒ ä¸æ¨èï¼šä½¿ç”¨é»˜è®¤é…ç½®
@RestController
public class UserController {

    @RpcReference
    private UserService userService; // é…ç½®ä¸æ˜ç¡®
}
```

### 2. é…ç½®ç®¡ç†æœ€ä½³å®è·µ

#### ç¯å¢ƒé…ç½®åˆ†ç¦»
```yaml
# application-dev.yml (å¼€å‘ç¯å¢ƒ)
rpc:
  serverHost: localhost
  serverPort: 8080
  registryConfig:
    registry: MOCK

# application-prod.yml (ç”Ÿäº§ç¯å¢ƒ)
rpc:
  serverHost: ${RPC_HOST:0.0.0.0}
  serverPort: ${RPC_PORT:8080}
  registryConfig:
    registry: ETCD
    address: ${ETCD_ADDRESS:localhost:2379}
```

### 3. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

#### å…¨å±€å¼‚å¸¸å¤„ç†
```java
@ControllerAdvice
public class RpcExceptionHandler {

    @ExceptionHandler(RpcException.class)
    public ResponseEntity<ErrorResponse> handleRpcException(RpcException e) {
        ErrorResponse error = new ErrorResponse();
        error.setCode("RPC_ERROR");
        error.setMessage(e.getMessage());
        return ResponseEntity.status(500).body(error);
    }
}
```

## ğŸ“‹ æ€»ç»“

Ming RPC Frameworké€šè¿‡æ³¨è§£é©±åŠ¨æœºåˆ¶å®ç°äº†å¼€å‘æˆæœ¬çš„æ˜¾è‘—é™ä½ï¼š

### ğŸ‰ æ ¸å¿ƒæˆæœ
- **ä»£ç é‡å‡å°‘77%**: ä»100è¡Œå‡å°‘åˆ°23è¡Œ
- **å­¦ä¹ æˆæœ¬é™ä½80%**: ç®€åŒ–å­¦ä¹ è·¯å¾„
- **é”™è¯¯ç‡é™ä½90%**: è‡ªåŠ¨åŒ–é…ç½®å‡å°‘äººä¸ºé”™è¯¯
- **å¼€å‘æ•ˆç‡æå‡500%+**: æ˜¾è‘—ç¼©çŸ­å¼€å‘æ—¶é—´

### ğŸ”§ æŠ€æœ¯ç‰¹è‰²
- **å£°æ˜å¼é…ç½®**: é€šè¿‡æ³¨è§£å£°æ˜æ„å›¾ï¼Œæ¡†æ¶è‡ªåŠ¨å¤„ç†
- **è‡ªåŠ¨è£…é…**: Beanåç½®å¤„ç†å™¨è‡ªåŠ¨æ³¨å…¥RPCä»£ç†
- **Springé›†æˆ**: æ— ç¼èå…¥Springç”Ÿæ€ç³»ç»Ÿ
- **çº¦å®šå¤§äºé…ç½®**: æä¾›åˆç†é»˜è®¤å€¼ï¼Œå‡å°‘é…ç½®

### ğŸ’¡ è®¾è®¡ç†å¿µ
- **å¼€å‘è€…å‹å¥½**: é™ä½ä½¿ç”¨é—¨æ§›ï¼Œæå‡å¼€å‘ä½“éªŒ
- **ç”Ÿäº§å°±ç»ª**: ä¼ä¸šçº§ç‰¹æ€§ï¼Œæ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²
- **å¯æ‰©å±•æ€§**: æ”¯æŒè‡ªå®šä¹‰é…ç½®å’Œç­–ç•¥
- **å‘åå…¼å®¹**: ä¿æŒAPIç¨³å®šæ€§

é€šè¿‡æ³¨è§£é©±åŠ¨ï¼ŒMing RPC FrameworkçœŸæ­£å®ç°äº†å¯¹å¤æ‚æ€§çš„å°è£…ï¼Œè®©åˆ†å¸ƒå¼æœåŠ¡è°ƒç”¨å˜å¾—ç®€å•è€Œé€æ˜ï¼Œè¿™æ­£æ˜¯ä¼˜ç§€æ¡†æ¶è®¾è®¡çš„ç²¾é«“æ‰€åœ¨ã€‚