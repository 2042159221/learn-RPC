# Ming RPC Framework å¼€å‘æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

#### ç³»ç»Ÿè¦æ±‚
- **JDK**: 21 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Maven**: 3.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **IDE**: IntelliJ IDEA æˆ– VS Code (æ¨è)

#### å¯é€‰ç»„ä»¶
- **ETCD**: 3.5+ (ç”Ÿäº§ç¯å¢ƒæ³¨å†Œä¸­å¿ƒ)
- **ZooKeeper**: 3.7+ (å¯é€‰æ³¨å†Œä¸­å¿ƒ)
- **Docker**: ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²

### é¡¹ç›®æ„å»º

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/ming/learn-RPC.git
cd learn-RPC
```

#### 2. ç¼–è¯‘é¡¹ç›®
```bash
# ç¼–è¯‘æ‰€æœ‰æ¨¡å—
mvn clean compile

# è¿è¡Œæµ‹è¯•
mvn test

# æ‰“åŒ…é¡¹ç›®
mvn clean package
```

#### 3. å®‰è£…åˆ°æœ¬åœ°ä»“åº“
```bash
mvn clean install
```

## ğŸ“¦ æ¨¡å—ä¾èµ–

### æ ¸å¿ƒä¾èµ–
```xml
<!-- Ming RPC Spring Boot Starter -->
<dependency>
    <groupId>com.ming</groupId>
    <artifactId>ming-rpc-spring-boot-starter</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>

<!-- å…¬å…±æ¥å£å®šä¹‰ -->
<dependency>
    <groupId>com.ming</groupId>
    <artifactId>example-common</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### Spring Bootä¾èµ–
```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.2.0</version>
    <relativePath/>
</parent>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

## ğŸ”§ æœåŠ¡æä¾›è€…å¼€å‘

### 1. åˆ›å»ºæœåŠ¡æ¥å£
```java
// example-common/src/main/java/com/ming/example/common/service/UserService.java
public interface UserService {
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    User getUser(User user);
    
    /**
     * åˆ›å»ºç”¨æˆ·
     */
    User createUser(User user);
    
    /**
     * åˆ é™¤ç”¨æˆ·
     */
    boolean deleteUser(String userId);
}
```

### 2. å®ç°æœåŠ¡æ¥å£
```java
// example-springboot-provider/src/main/java/com/ming/example/provider/service/UserServiceImpl.java
@Service
@RpcService(serviceVersion = "1.0")
public class UserServiceImpl implements UserService {
    
    private static final Logger log = LoggerFactory.getLogger(UserServiceImpl.class);
    
    @Override
    public User getUser(User user) {
        log.info("Provider received request for user: {}", user);
        
        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
        User result = new User();
        result.setName("Provider processed: " + user.getName());
        result.setId(System.currentTimeMillis());
        result.setEmail(user.getName() + "@example.com");
        
        log.info("Provider returning user: {}", result);
        return result;
    }
    
    @Override
    public User createUser(User user) {
        log.info("Provider creating user: {}", user);
        
        // æ¨¡æ‹Ÿç”¨æˆ·åˆ›å»ºé€»è¾‘
        user.setId(System.currentTimeMillis());
        user.setCreateTime(new Date());
        
        return user;
    }
    
    @Override
    public boolean deleteUser(String userId) {
        log.info("Provider deleting user: {}", userId);
        
        // æ¨¡æ‹Ÿåˆ é™¤é€»è¾‘
        return true;
    }
}
```

### 3. é…ç½®å¯åŠ¨ç±»
```java
// example-springboot-provider/src/main/java/com/ming/example/provider/ProviderApplication.java
@SpringBootApplication
@EnableRpc(needServer = true)  // å¯ç”¨RPCæœåŠ¡å™¨
public class ProviderApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(ProviderApplication.class, args);
    }
}
```

### 4. é…ç½®æ–‡ä»¶
```yaml
# example-springboot-provider/src/main/resources/application.yml
server:
  port: 8081  # Spring Boot HTTPç«¯å£

spring:
  application:
    name: ming-rpc-provider

# Ming RPC é…ç½®
rpc:
  name: ming-rpc-provider
  version: 1.0
  serverHost: localhost
  serverPort: 8080  # RPCæœåŠ¡ç«¯å£
  serializer: JDK
  loadBalancer: ROUND_ROBIN
  retryStrategy: NO
  tolerantStrategy: FAIL_FAST
  mock: false
  
  # æ³¨å†Œä¸­å¿ƒé…ç½®
  registryConfig:
    registry: MOCK  # å¼€å‘ç¯å¢ƒä½¿ç”¨MOCKï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ETCD
    address: http://localhost:2380
    timeout: 10000

# æ—¥å¿—é…ç½®
logging:
  level:
    com.ming: INFO
    com.ming.rpc: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

## ğŸ” æœåŠ¡æ¶ˆè´¹è€…å¼€å‘

### 1. åˆ›å»ºæ§åˆ¶å™¨
```java
// example-springboot-consumer/src/main/java/com/ming/example/consumer/controller/UserController.java
@Slf4j
@RestController
@RequestMapping("/user")
public class UserController {

    /**
     * æ³¨å…¥è¿œç¨‹ç”¨æˆ·æœåŠ¡
     */
    @RpcReference(serviceVersion = "1.0")
    private UserService userService;

    /**
     * å¥åº·æ£€æŸ¥æ¥å£
     */
    @GetMapping("/health")
    public String health() {
        return "Consumer is healthy";
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/{name}")
    public User getUser(@PathVariable("name") String name) {
        log.info("Consumer received request for user: {}", name);
        
        // æ£€æŸ¥RPCæœåŠ¡æ˜¯å¦å¯ç”¨
        if (userService == null) {
            log.warn("RPC service is not available, returning mock response");
            User mockResult = new User();
            mockResult.setName("Mock response (RPC service unavailable): " + name);
            return mockResult;
        }
        
        try {
            // åˆ›å»ºç”¨æˆ·å¯¹è±¡
            User user = new User();
            user.setName(name);
            
            // è°ƒç”¨è¿œç¨‹æœåŠ¡
            User result = userService.getUser(user);
            log.info("Consumer received response: {}", result);
            return result;
        } catch (Exception e) {
            log.error("RPC call failed: {}", e.getMessage());
            User errorResult = new User();
            errorResult.setName("Error response (RPC call failed): " + name);
            return errorResult;
        }
    }

    /**
     * åˆ›å»ºç”¨æˆ·
     */
    @PostMapping
    public User createUser(@RequestBody User user) {
        log.info("Consumer received create user request: {}", user);
        
        if (userService == null) {
            throw new RuntimeException("RPC service is not available");
        }
        
        // è°ƒç”¨è¿œç¨‹æœåŠ¡
        User result = userService.createUser(user);
        
        log.info("Consumer received create user response: {}", result);
        return result;
    }
    
    /**
     * åˆ é™¤ç”¨æˆ·
     */
    @DeleteMapping("/{userId}")
    public Map<String, Object> deleteUser(@PathVariable String userId) {
        log.info("Consumer received delete user request: {}", userId);
        
        Map<String, Object> response = new HashMap<>();
        
        if (userService == null) {
            response.put("success", false);
            response.put("message", "RPC service is not available");
            return response;
        }
        
        try {
            boolean result = userService.deleteUser(userId);
            response.put("success", result);
            response.put("message", result ? "User deleted successfully" : "Failed to delete user");
        } catch (Exception e) {
            log.error("Delete user failed: {}", e.getMessage());
            response.put("success", false);
            response.put("message", "Delete user failed: " + e.getMessage());
        }
        
        return response;
    }
}
```

### 2. é…ç½®å¯åŠ¨ç±»
```java
// example-springboot-consumer/src/main/java/com/ming/example/consumer/ConsumerApplication.java
@SpringBootApplication
@EnableRpc(needServer = false)  // ä¸éœ€è¦å¯åŠ¨RPCæœåŠ¡å™¨
public class ConsumerApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(ConsumerApplication.class, args);
    }
}
```

### 3. é…ç½®æ–‡ä»¶
```yaml
# example-springboot-consumer/src/main/resources/application.yml
server:
  port: 8082  # Spring Boot HTTPç«¯å£

spring:
  application:
    name: ming-rpc-consumer

# Ming RPC é…ç½®
rpc:
  name: ming-rpc-consumer
  version: 1.0
  serverHost: localhost
  serverPort: 8080  # ä¸å¯åŠ¨RPCæœåŠ¡å™¨ï¼Œæ­¤é…ç½®æ— æ•ˆ
  serializer: JDK
  loadBalancer: ROUND_ROBIN
  retryStrategy: NO
  tolerantStrategy: FAIL_FAST
  mock: false
  
  # æ³¨å†Œä¸­å¿ƒé…ç½®
  registryConfig:
    registry: MOCK  # å¼€å‘ç¯å¢ƒä½¿ç”¨MOCKï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ETCD
    address: http://localhost:2380
    timeout: 10000

# æ—¥å¿—é…ç½®
logging:
  level:
    com.ming: INFO
    com.ming.rpc: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

## ğŸ§ª æµ‹è¯•å¼€å‘

### 1. å•å…ƒæµ‹è¯•
```java
// example-springboot-provider/src/test/java/com/ming/example/provider/service/UserServiceImplTest.java
@ExtendWith(MockitoExtension.class)
class UserServiceImplTest {
    
    @InjectMocks
    private UserServiceImpl userService;
    
    @Test
    void testGetUser() {
        // Given
        User inputUser = new User();
        inputUser.setName("testUser");
        
        // When
        User result = userService.getUser(inputUser);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getName()).contains("Provider processed: testUser");
        assertThat(result.getId()).isNotNull();
        assertThat(result.getEmail()).isEqualTo("testUser@example.com");
    }
    
    @Test
    void testCreateUser() {
        // Given
        User inputUser = new User();
        inputUser.setName("newUser");
        inputUser.setEmail("new@example.com");
        
        // When
        User result = userService.createUser(inputUser);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isNotNull();
        assertThat(result.getCreateTime()).isNotNull();
        assertThat(result.getName()).isEqualTo("newUser");
    }
    
    @Test
    void testDeleteUser() {
        // Given
        String userId = "12345";
        
        // When
        boolean result = userService.deleteUser(userId);
        
        // Then
        assertThat(result).isTrue();
    }
}
```

### 2. é›†æˆæµ‹è¯•
```java
// example-springboot-consumer/src/test/java/com/ming/example/consumer/integration/ConsumerIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(properties = {
    "rpc.mock=true",  // å¯ç”¨Mockæ¨¡å¼
    "rpc.registryConfig.registry=MOCK"
})
class ConsumerIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @LocalServerPort
    private int port;
    
    @Test
    void testHealthEndpoint() {
        // When
        String response = restTemplate.getForObject(
            "http://localhost:" + port + "/user/health", 
            String.class
        );
        
        // Then
        assertThat(response).isEqualTo("Consumer is healthy");
    }
    
    @Test
    void testGetUserEndpoint() {
        // When
        User response = restTemplate.getForObject(
            "http://localhost:" + port + "/user/testUser", 
            User.class
        );
        
        // Then
        assertThat(response).isNotNull();
        assertThat(response.getName()).contains("testUser");
    }
    
    @Test
    void testCreateUserEndpoint() {
        // Given
        User user = new User();
        user.setName("newUser");
        user.setEmail("new@example.com");
        
        // When
        User response = restTemplate.postForObject(
            "http://localhost:" + port + "/user", 
            user, 
            User.class
        );
        
        // Then
        assertThat(response).isNotNull();
        assertThat(response.getName()).isEqualTo("newUser");
    }
}
```

### 3. ç«¯åˆ°ç«¯æµ‹è¯•
```java
// integration-tests/src/test/java/com/ming/rpc/integration/SpringBootRpcIntegrationTest.java
@SpringBootTest
@TestPropertySource(properties = {
    "rpc.mock=true",
    "rpc.registryConfig.registry=MOCK"
})
class SpringBootRpcIntegrationTest {
    
    @RpcReference
    private UserService userService;
    
    @Test
    void testRpcServiceInjection() {
        assertThat(userService).isNotNull();
    }
    
    @Test
    void testRpcServiceCall() {
        // Given
        User user = new User();
        user.setName("integrationTest");
        
        // When
        User result = userService.getUser(user);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getName()).contains("integrationTest");
    }
    
    @Test
    void testRpcServiceCallWithNullInput() {
        // When & Then
        assertThatThrownBy(() -> userService.getUser(null))
            .isInstanceOf(Exception.class);
    }
    
    @Test
    void testMultipleRpcCalls() {
        // Given
        List<String> userNames = Arrays.asList("user1", "user2", "user3");
        
        // When
        List<User> results = userNames.stream()
            .map(name -> {
                User user = new User();
                user.setName(name);
                return userService.getUser(user);
            })
            .collect(Collectors.toList());
        
        // Then
        assertThat(results).hasSize(3);
        assertThat(results).allMatch(user -> user.getName() != null);
    }
}
```

## ğŸ”§ é…ç½®è¯¦è§£

### RPCé…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `rpc.name` | String | ming-rpc | RPCåº”ç”¨åç§° |
| `rpc.version` | String | 1.0 | RPCåº”ç”¨ç‰ˆæœ¬ |
| `rpc.serverHost` | String | localhost | RPCæœåŠ¡å™¨ä¸»æœº |
| `rpc.serverPort` | Integer | 8080 | RPCæœåŠ¡å™¨ç«¯å£ |
| `rpc.serializer` | String | JDK | åºåˆ—åŒ–å™¨ç±»å‹ |
| `rpc.loadBalancer` | String | ROUND_ROBIN | è´Ÿè½½å‡è¡¡ç­–ç•¥ |
| `rpc.retryStrategy` | String | NO | é‡è¯•ç­–ç•¥ |
| `rpc.tolerantStrategy` | String | FAIL_FAST | å®¹é”™ç­–ç•¥ |
| `rpc.mock` | Boolean | false | æ˜¯å¦å¯ç”¨Mockæ¨¡å¼ |

### åºåˆ—åŒ–å™¨é€‰æ‹©

| åºåˆ—åŒ–å™¨ | é…ç½®å€¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|---------|--------|------|------|----------|
| JDK | JDK | å…¼å®¹æ€§å¥½ | æ€§èƒ½ä¸€èˆ¬ï¼Œä½“ç§¯å¤§ | å¼€å‘æµ‹è¯• |
| JSON | JSON | å¯è¯»æ€§å¼ºï¼Œè·¨è¯­è¨€ | ç±»å‹ä¿¡æ¯ä¸¢å¤± | å‰åç«¯äº¤äº’ |
| Hessian | HESSIAN | é«˜æ€§èƒ½ï¼Œä½“ç§¯å° | ç‰ˆæœ¬å…¼å®¹æ€§ | ç”Ÿäº§ç¯å¢ƒ |

### è´Ÿè½½å‡è¡¡ç­–ç•¥

| ç­–ç•¥ | é…ç½®å€¼ | ç®—æ³• | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|
| è½®è¯¢ | ROUND_ROBIN | ä¾æ¬¡è½®è¯¢ | æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ |
| éšæœº | RANDOM | éšæœºé€‰æ‹© | ç®€å•åœºæ™¯ |
| ä¸€è‡´æ€§å“ˆå¸Œ | CONSISTENT_HASH | å“ˆå¸Œç¯ | æœ‰çŠ¶æ€æœåŠ¡ |

### å®¹é”™ç­–ç•¥

| ç­–ç•¥ | é…ç½®å€¼ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|
| å¿«é€Ÿå¤±è´¥ | FAIL_FAST | ç«‹å³æŠ›å¼‚å¸¸ | ä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚ |
| æ•…éšœè½¬ç§» | FAIL_BACK | å°è¯•å…¶ä»–èŠ‚ç‚¹ | é«˜å¯ç”¨è¦æ±‚ |
| é™é»˜å¤„ç† | FAIL_SAFE | å¿½ç•¥å¼‚å¸¸ | éå…³é”®æœåŠ¡ |

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒéƒ¨ç½²
```bash
# 1. å¯åŠ¨Provider
cd example-springboot-provider
mvn spring-boot:run

# 2. å¯åŠ¨Consumer
cd example-springboot-consumer
mvn spring-boot:run

# 3. æµ‹è¯•æ¥å£
curl http://localhost:8082/user/health
curl http://localhost:8082/user/å¼ ä¸‰
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# 1. æ‰“åŒ…åº”ç”¨
mvn clean package

# 2. å¯åŠ¨Provider
java -jar example-springboot-provider/target/example-springboot-provider-1.0-SNAPSHOT.jar

# 3. å¯åŠ¨Consumer
java -jar example-springboot-consumer/target/example-springboot-consumer-1.0-SNAPSHOT.jar
```

### Dockeréƒ¨ç½²
```dockerfile
# Dockerfile
FROM openjdk:21-jre-slim

COPY target/*.jar app.jar

EXPOSE 8080 8081

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    ports:
      - "2379:2379"
      - "2380:2380"
    environment:
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://localhost:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://localhost:2380
      - ETCD_INITIAL_CLUSTER=default=http://localhost:2380
      - ETCD_NAME=default
      - ETCD_DATA_DIR=/etcd-data

  provider:
    build: ./example-springboot-provider
    ports:
      - "8081:8081"
      - "8080:8080"
    depends_on:
      - etcd
    environment:
      - RPC_REGISTRY_CONFIG_ADDRESS=http://etcd:2379

  consumer:
    build: ./example-springboot-consumer
    ports:
      - "8082:8082"
    depends_on:
      - provider
    environment:
      - RPC_REGISTRY_CONFIG_ADDRESS=http://etcd:2379
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æœåŠ¡æ³¨å†Œå¤±è´¥
**ç°è±¡**: Providerå¯åŠ¨æ—¶æŠ¥æ³¨å†Œä¸­å¿ƒè¿æ¥å¤±è´¥
**è§£å†³**: 
- æ£€æŸ¥æ³¨å†Œä¸­å¿ƒæ˜¯å¦å¯åŠ¨
- ç¡®è®¤ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- éªŒè¯é…ç½®åœ°å€æ˜¯å¦æ­£ç¡®

#### 2. æœåŠ¡å‘ç°å¤±è´¥
**ç°è±¡**: Consumerè°ƒç”¨æ—¶æ‰¾ä¸åˆ°æœåŠ¡
**è§£å†³**:
- ç¡®è®¤Providerå·²æˆåŠŸæ³¨å†Œ
- æ£€æŸ¥æœåŠ¡åå’Œç‰ˆæœ¬æ˜¯å¦åŒ¹é…
- éªŒè¯æ³¨å†Œä¸­å¿ƒé…ç½®æ˜¯å¦ä¸€è‡´

#### 3. åºåˆ—åŒ–å¼‚å¸¸
**ç°è±¡**: è°ƒç”¨æ—¶å‡ºç°åºåˆ—åŒ–/ååºåˆ—åŒ–é”™è¯¯
**è§£å†³**:
- ç¡®ä¿Providerå’ŒConsumerä½¿ç”¨ç›¸åŒåºåˆ—åŒ–å™¨
- æ£€æŸ¥å¯¹è±¡æ˜¯å¦å®ç°Serializableæ¥å£
- éªŒè¯ç±»è·¯å¾„ä¸­æ˜¯å¦åŒ…å«ç›¸å…³ä¾èµ–

#### 4. ç½‘ç»œè¿æ¥è¶…æ—¶
**ç°è±¡**: RPCè°ƒç”¨è¶…æ—¶
**è§£å†³**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- è°ƒæ•´è¶…æ—¶é…ç½®
- ç¡®è®¤é˜²ç«å¢™è®¾ç½®

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è°ƒè¯•æ—¥å¿—
```yaml
logging:
  level:
    com.ming.rpc: DEBUG
    root: INFO
```

#### 2. ä½¿ç”¨Mockæ¨¡å¼
```yaml
rpc:
  mock: true
  registryConfig:
    registry: MOCK
```

#### 3. å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥Providerå¥åº·çŠ¶æ€
curl http://localhost:8081/actuator/health

# æ£€æŸ¥Consumerå¥åº·çŠ¶æ€
curl http://localhost:8082/user/health
```

è¿™ä¸ªå¼€å‘æŒ‡å—æä¾›äº†å®Œæ•´çš„å¼€å‘æµç¨‹ï¼Œä»ç¯å¢ƒæ­å»ºåˆ°éƒ¨ç½²ä¸Šçº¿ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹Ming RPC Frameworkã€‚
