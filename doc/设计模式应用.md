# Ming RPC Framework è®¾è®¡æ¨¡å¼åº”ç”¨è¯¦è§£

## ğŸ“– æ¦‚è¿°

è®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶å¼€å‘ä¸­ç»è¿‡éªŒè¯çš„ã€ç”¨äºè§£å†³ç‰¹å®šé—®é¢˜çš„æœ€ä½³å®è·µã€‚Ming RPC Frameworkå·§å¦™åœ°è¿ç”¨äº†å¤šç§è®¾è®¡æ¨¡å¼ï¼Œæ„å»ºäº†ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•ã€å¯ç»´æŠ¤çš„åˆ†å¸ƒå¼RPCæ¡†æ¶ã€‚

### ğŸ¯ æ ¸å¿ƒé—®é¢˜
> åœ¨Ming RPC Frameworkä¸­ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿä¸¾ä¾‹è¯´æ˜æ˜¯å¦‚ä½•åº”ç”¨çš„ã€‚

### ğŸ’¡ è®¾è®¡æ¨¡å¼çš„ä»·å€¼
1. **å¯æ‰©å±•æ€§**: é€šè¿‡å·¥å‚æ¨¡å¼å’ŒSPIæœºåˆ¶å®ç°ç»„ä»¶çš„åŠ¨æ€æ‰©å±•
2. **å¯ç»´æŠ¤æ€§**: é€šè¿‡ä»£ç†æ¨¡å¼å’Œè£…é¥°å™¨æ¨¡å¼å®ç°å…³æ³¨ç‚¹åˆ†ç¦»
3. **çµæ´»æ€§**: é€šè¿‡ç­–ç•¥æ¨¡å¼æ”¯æŒå¤šç§ç®—æ³•çš„åŠ¨æ€åˆ‡æ¢
4. **è§£è€¦æ€§**: é€šè¿‡è§‚å¯Ÿè€…æ¨¡å¼å®ç°ç»„ä»¶é—´çš„æ¾è€¦åˆ

### ğŸ—ï¸ è®¾è®¡æ¨¡å¼æ¶æ„å›¾
```mermaid
graph TD
    A[Ming RPC Framework] --> B[åˆ›å»ºå‹æ¨¡å¼]
    A --> C[ç»“æ„å‹æ¨¡å¼]
    A --> D[è¡Œä¸ºå‹æ¨¡å¼]

    B --> B1[å·¥å‚æ¨¡å¼]
    B --> B2[å•ä¾‹æ¨¡å¼]
    B --> B3[å»ºé€ è€…æ¨¡å¼]

    C --> C1[ä»£ç†æ¨¡å¼]
    C --> C2[è£…é¥°å™¨æ¨¡å¼]
    C --> C3[é€‚é…å™¨æ¨¡å¼]

    D --> D1[ç­–ç•¥æ¨¡å¼]
    D --> D2[è§‚å¯Ÿè€…æ¨¡å¼]
    D --> D3[æ¨¡æ¿æ–¹æ³•æ¨¡å¼]

    style A fill:#e1f5fe
    style B fill:#e8f5e8
    style C fill:#fff3e0
    style D fill:#f3e5f5
```

## ğŸ­ 1. ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰

### 1.1 æ¨¡å¼å®šä¹‰ä¸ä»·å€¼

ä»£ç†æ¨¡å¼ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚åœ¨Ming RPC Frameworkä¸­ï¼Œä»£ç†æ¨¡å¼æ˜¯å®ç°è¿œç¨‹è°ƒç”¨é€æ˜åŒ–çš„æ ¸å¿ƒï¼Œè®©å®¢æˆ·ç«¯åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡ã€‚

### 1.2 é™æ€ä»£ç†å®ç°

#### UserServiceProxyé™æ€ä»£ç†
**æ–‡ä»¶è·¯å¾„**: `example-consumer/src/main/java/com/ming/example/consumer/client/proxy/UserServiceProxy.java`

```java
/**
 * é™æ€ä»£ç†å®ç°
 */
public class UserServiceProxy implements UserService {

    @Override
    public User getUser(User user) {
        System.out.println("å¼€å§‹è°ƒç”¨è¿œç¨‹æœåŠ¡...");

        // 1. åºåˆ—åŒ–è¯·æ±‚
        Serializer serializer = new JdkSerializer();
        RpcRequest rpcRequest = RpcRequest.builder()
                .serviceName(UserService.class.getName())
                .methodName("getUser")
                .parameterTypes(new Class[]{User.class})
                .args(new Object[]{user})
                .build();

        try {
            System.out.println("æ­£åœ¨åºåˆ—åŒ–è¯·æ±‚...");
            byte[] bodyBytes = serializer.serialize(rpcRequest);
            byte[] result;

            // 2. å‘é€HTTPè¯·æ±‚
            try(HttpResponse httpResponse = HttpRequest.post("http://localhost:8080")
                .body(bodyBytes)
                .execute()){
                System.out.println("è¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨è·å–å“åº”...");
                result = httpResponse.bodyBytes();
            }

            // 3. ååºåˆ—åŒ–å“åº”
            RpcResponse rpcResponse = serializer.deserialize(result, RpcResponse.class);
            return (User) rpcResponse.getData();

        } catch(Exception e) {
            System.err.println("RPCè°ƒç”¨å¤±è´¥: " + e.getMessage());
            throw new RuntimeException(e);
        }
    }
}
```

### 1.3 åŠ¨æ€ä»£ç†å®ç°

#### ServiceProxyFactoryä»£ç†å·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/proxy/ServiceProxyFactory.java`

```java
/**
 * æœåŠ¡ä»£ç†å·¥å‚ï¼ˆå·¥å‚æ¨¡å¼ï¼Œç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡ï¼‰
 */
public class ServiceProxyFactory {

    /**
     * è·å–æœåŠ¡ä»£ç†å¯¹è±¡
     */
    public static <T> T getProxy(Class<T> serviceClass) {
        // æ ¹æ®é…ç½®å†³å®šè¿”å›Mockä»£ç†è¿˜æ˜¯çœŸå®ä»£ç†
        if (RpcApplication.getRpcConfig().isMock()) {
            return getMockProxy(serviceClass);
        }

        return (T) Proxy.newProxyInstance(
            serviceClass.getClassLoader(),
            new Class[] { serviceClass },
            new ServiceProxy()
        );
    }

    /**
     * æ ¹æ®æœåŠ¡ç±»è·å–Mockä»£ç†å¯¹è±¡
     */
    public static <T> T getMockProxy(Class<T> serviceClass) {
        return (T) Proxy.newProxyInstance(
            serviceClass.getClassLoader(),
            new Class[] { serviceClass },
            new MockServiceProxy()
        );
    }
}
```

#### ServiceProxyåŠ¨æ€ä»£ç†å¤„ç†å™¨
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/proxy/ServiceProxy.java`

```java
/**
 * æœåŠ¡ä»£ç†ï¼ˆJDKåŠ¨æ€ä»£ç†ï¼‰
 */
public class ServiceProxy implements InvocationHandler {

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // æ„é€ RPCè¯·æ±‚
        String serviceName = method.getDeclaringClass().getName();
        RpcRequest rpcRequest = RpcRequest.builder()
            .serviceName(serviceName)
            .methodName(method.getName())
            .parameterTypes(method.getParameterTypes())
            .args(args)
            .build();

        // æœåŠ¡å‘ç°
        RpcConfig rpcConfig = RpcApplication.getRpcConfig();
        Registry registry = RegistryFactory.getInstance(rpcConfig.getRegistryConfig().getRegistry());
        ServiceMetaInfo serviceMetaInfo = new ServiceMetaInfo();
        serviceMetaInfo.setServiceName(serviceName);
        serviceMetaInfo.setServiceVersion(RpcConstant.DEFAULT_SERVICE_VERSION);
        List<ServiceMetaInfo> serviceMetaInfoList = registry.serviceDiscovery(serviceMetaInfo.getServiceKey());

        if (CollUtil.isEmpty(serviceMetaInfoList)) {
            throw new RuntimeException("æš‚æ— æœåŠ¡åœ°å€");
        }

        // è´Ÿè½½å‡è¡¡
        LoadBalancer loadBalancer = LoadBalancerFactory.getInstance(rpcConfig.getLoadBalancer());
        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("methodName", rpcRequest.getMethodName());
        ServiceMetaInfo selectedServiceMetaInfo = loadBalancer.select(requestParams, serviceMetaInfoList);

        // å‘é€RPCè¯·æ±‚ï¼ˆåŒ…å«é‡è¯•å’Œå®¹é”™æœºåˆ¶ï¼‰
        RpcResponse rpcResponse;
        try {
            RetryStrategy retryStrategy = RetryStrategyFactory.getInstance(rpcConfig.getRetryStrategy());
            rpcResponse = retryStrategy.doRetry(() ->
                    VertexTcpClient.doRequest(rpcRequest, selectedServiceMetaInfo)
            );
        } catch (Exception e) {
            // å®¹é”™æœºåˆ¶
            TolerantStrategy tolerantStrategy = TolerantStrategyFactory.getInstance(rpcConfig.getTolerantStrategy());
            rpcResponse = tolerantStrategy.doTolerant(null, e);
        }

        return rpcResponse.getData();
    }
}
```

```java
public static <T> T getProxy(Class<T> serviceClass, String host, int port) {
    HttpClient httpClient = new HttpClient();
    
    return (T) Proxy.newProxyInstance(
            serviceClass.getClassLoader(),
            new Class[]{serviceClass},
            new ServiceInvocationHandler(httpClient, serviceClass, host, port)
    );
}
```

`ServiceInvocationHandler`å®ç°äº†`InvocationHandler`æ¥å£ï¼Œæ‹¦æˆªæ–¹æ³•è°ƒç”¨ï¼š

```java
@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    // å¤„ç†Objectç±»çš„æ–¹æ³•
    if (method.getDeclaringClass() == Object.class) {
        return method.invoke(this, args);
    }
    
    // æ„å»ºRPCè¯·æ±‚
    RpcRequest rpcRequest = RpcRequest.builder()
            .serviceName(serviceClass.getName())
            .methodName(method.getName())
            .parameterTypes(method.getParameterTypes())
            .args(args)
            .build();
    
    // å‘é€è¯·æ±‚å¹¶è·å–å“åº”
    RpcResponse rpcResponse = httpClient.sendRequest(rpcRequest, host, port);
    
    // è¿”å›ç»“æœ
    return rpcResponse.getData();
}
```

### 1.3 ä¼˜åŠ¿

- **é€æ˜æ€§**ï¼šå®¢æˆ·ç«¯ä»£ç æ— éœ€å…³æ³¨è¿œç¨‹è°ƒç”¨çš„å¤æ‚æ€§ï¼Œå¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡
- **è§£è€¦**ï¼šå°†ç½‘ç»œä¼ è¾“ã€åºåˆ—åŒ–ç­‰é€»è¾‘ä¸ä¸šåŠ¡ä»£ç åˆ†ç¦»
- **é›†ä¸­æ§åˆ¶**ï¼šå¯ä»¥åœ¨ä»£ç†ä¸­ç»Ÿä¸€å¤„ç†è¯·æ±‚æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ã€è¶…æ—¶é‡è¯•ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹

## ğŸ­ 2. å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

### 2.1 æ¨¡å¼å®šä¹‰ä¸ä»·å€¼

å·¥å‚æ¨¡å¼æä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ï¼Œå°è£…äº†å¯¹è±¡çš„åˆ›å»ºé€»è¾‘ï¼Œä½¿å®¢æˆ·ç«¯æ— éœ€å…³å¿ƒå…·ä½“çš„åˆ›å»ºç»†èŠ‚ã€‚åœ¨Ming RPC Frameworkä¸­ï¼Œå·¥å‚æ¨¡å¼å¹¿æ³›åº”ç”¨äºå„ç§ç»„ä»¶çš„åˆ›å»ºå’Œç®¡ç†ã€‚

### 2.2 æ³¨å†Œä¸­å¿ƒå·¥å‚

#### RegistryFactory - æ³¨å†Œä¸­å¿ƒå·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/registry/RegistryFactory.java`

```java
/**
 * æ³¨å†Œä¸­å¿ƒå·¥å‚ï¼ˆç”¨äºè·å–æ³¨å†Œä¸­å¿ƒå¯¹è±¡ï¼‰
 */
public class RegistryFactory {

    /**
     * SPI åŠ¨æ€åŠ è½½
     */
    static {
        SpiLoader.load(Registry.class);
    }

    /**
     * é»˜è®¤æ³¨å†Œä¸­å¿ƒ
     */
    private static final Registry DEFAULT_REGISTRY = new EtcdRegistry();

    /**
     * è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹
     * @param key æ³¨å†Œä¸­å¿ƒç±»å‹
     * @return æ³¨å†Œä¸­å¿ƒå®ä¾‹
     */
    public static Registry getInstance(String key) {
        return SpiLoader.getInstance(Registry.class, key);
    }
}
```

### 2.3 è´Ÿè½½å‡è¡¡å™¨å·¥å‚

#### LoadBalancerFactory - è´Ÿè½½å‡è¡¡å™¨å·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/loadbalancer/LoadBalancerFactory.java`

```java
/**
 * è´Ÿè½½å‡è¡¡å™¨å·¥å‚ï¼ˆå·¥å‚æ¨¡å¼ï¼Œç”¨äºè·å–è´Ÿè½½å‡è¡¡å™¨å¯¹è±¡ï¼‰
 */
public class LoadBalancerFactory {

    static {
        SpiLoader.load(LoadBalancer.class);
    }

    /**
     * é»˜è®¤è´Ÿè½½å‡è¡¡å™¨
     */
    private static final LoadBalancer DEFAULT_LOAD_BALANCER = new RoundRobinLoadBalancer();

    /**
     * è·å–å®ä¾‹
     * @param key è´Ÿè½½å‡è¡¡å™¨ç±»å‹
     * @return è´Ÿè½½å‡è¡¡å™¨
     */
    public static LoadBalancer getInstance(String key) {
        return SpiLoader.getInstance(LoadBalancer.class, key);
    }
}
```

### 2.4 å®¹é”™ç­–ç•¥å·¥å‚

#### TolerantStrategyFactory - å®¹é”™ç­–ç•¥å·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/TolerantStrategyFactory.java`

```java
/**
 * å®¹é”™ç­–ç•¥å·¥å‚ï¼ˆå·¥å‚æ¨¡å¼ï¼Œç”¨äºè·å–å®¹é”™ç­–ç•¥å¯¹è±¡ï¼‰
 */
public class TolerantStrategyFactory {

    static {
        SpiLoader.load(TolerantStrategy.class);
    }

    /**
     * é»˜è®¤å®¹é”™ç­–ç•¥
     */
    private static final TolerantStrategy DEFAULT_TOLERANT_STRATEGY = new FailFastTolerantStrategy();

    /**
     * è·å–å®ä¾‹
     * @param key é”®
     * @return å®ä¾‹
     */
    public static TolerantStrategy getInstance(String key) {
        TolerantStrategy tolerantStrategy = SpiLoader.getInstance(TolerantStrategy.class, key);
        return tolerantStrategy == null ? DEFAULT_TOLERANT_STRATEGY : tolerantStrategy;
    }
}
```

### 2.5 å·¥å‚æ¨¡å¼ä¼˜åŠ¿

- **ç»Ÿä¸€åˆ›å»º**: æä¾›ç»Ÿä¸€çš„å¯¹è±¡åˆ›å»ºæ¥å£
- **é…ç½®é©±åŠ¨**: æ”¯æŒé€šè¿‡é…ç½®åŠ¨æ€é€‰æ‹©å®ç°
- **é»˜è®¤å®ç°**: æä¾›åˆç†çš„é»˜è®¤å®ç°ï¼Œç®€åŒ–ä½¿ç”¨
- **SPIé›†æˆ**: ä¸SPIæœºåˆ¶ç»“åˆï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•
- **å•ä¾‹ç®¡ç†**: é€šè¿‡SpiLoaderå®ç°å®ä¾‹çš„å•ä¾‹ç®¡ç†

## 3. å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰

### 3.1 å®šä¹‰ä¸ä½œç”¨

å•ä¾‹æ¨¡å¼ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚

### 3.2 é¡¹ç›®ä¸­çš„åº”ç”¨

`LocalRegistry`æ˜¯é¡¹ç›®ä¸­å•ä¾‹æ¨¡å¼çš„å…¸å‹åº”ç”¨ï¼š

```java
public class LocalRegistry {
    private static final Map<String,Class<?>> map = new ConcurrentHashMap<>();

    public static void register(String serviceName,Class<?> implClass){
        map.put(serviceName,implClass);
    }
    
    public static Class<?> get(String serviceName){
        return map.get(serviceName);
    }

    public static void remove(String serviceName){
        map.remove(serviceName);
    }
}
```

é€šè¿‡ä½¿ç”¨é™æ€æ–¹æ³•å’Œé™æ€å­—æ®µï¼Œ`LocalRegistry`ç¡®ä¿äº†å…¨å±€åªæœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œç»´æŠ¤ç€æœåŠ¡åç§°åˆ°å®ç°ç±»çš„æ˜ å°„å…³ç³»ã€‚

### 3.3 ä¼˜åŠ¿

- **å…¨å±€è®¿é—®ç‚¹**ï¼šä»»ä½•ä»£ç éƒ½å¯ä»¥é€šè¿‡é™æ€æ–¹æ³•è®¿é—®æ³¨å†Œä¸­å¿ƒ
- **èµ„æºå…±äº«**ï¼šæ‰€æœ‰ä»£ç å…±äº«åŒä¸€ä»½æœåŠ¡æ³¨å†Œä¿¡æ¯
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨`ConcurrentHashMap`ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„çº¿ç¨‹å®‰å…¨

## 4. å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰

### 4.1 å®šä¹‰ä¸ä½œç”¨

å»ºé€ è€…æ¨¡å¼ä½¿ç”¨å¤šä¸ªç®€å•å¯¹è±¡ä¸€æ­¥æ­¥æ„å»ºä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å…¶è¡¨ç¤ºåˆ†ç¦»ã€‚

### 4.2 é¡¹ç›®ä¸­çš„åº”ç”¨

é¡¹ç›®ä¸­çš„`RpcRequest`å’Œ`RpcResponse`ç±»é€šè¿‡Lombokçš„`@Builder`æ³¨è§£å®ç°äº†å»ºé€ è€…æ¨¡å¼ï¼š

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RpcRequest implements Serializable {
    private String serviceName;
    private String methodName;
    private Object[] args;
    private Class<?>[] parameterTypes;
}
```

ä½¿ç”¨å»ºé€ è€…æ¨¡å¼åˆ›å»ºè¯·æ±‚å¯¹è±¡ï¼š

```java
RpcRequest rpcRequest = RpcRequest.builder()
        .serviceName(serviceClass.getName())
        .methodName(method.getName())
        .parameterTypes(method.getParameterTypes())
        .args(args)
        .build();
```

### 4.3 ä¼˜åŠ¿

- **å¯è¯»æ€§**ï¼šé€šè¿‡é“¾å¼è°ƒç”¨å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹
- **çµæ´»æ€§**ï¼šåªéœ€è®¾ç½®å¿…è¦çš„å±æ€§ï¼Œå…¶ä»–å±æ€§å¯ä»¥ä¿æŒé»˜è®¤å€¼
- **ä¸å¯å˜æ€§**ï¼šæ„å»ºå®Œæˆåè¿”å›ä¸å¯å˜å¯¹è±¡ï¼Œæé«˜çº¿ç¨‹å®‰å…¨æ€§

## 5. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

### 5.1 å®šä¹‰ä¸ä½œç”¨

ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚

### 5.2 é¡¹ç›®ä¸­çš„åº”ç”¨

`Serializer`æ¥å£åŠå…¶å®ç°ç±»`JdkSerializer`ä½“ç°äº†ç­–ç•¥æ¨¡å¼ï¼š

```java
public interface Serializer {
    <T> byte[] serialize(T obj) throws Exception;
    <T> T deserialize(byte[] bytes, Class<T> clazz) throws Exception;
}

public class JdkSerializer implements Serializer {
    @Override
    public <T> byte[] serialize(T obj) throws Exception {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        objectOutputStream.writeObject(obj);
        return byteArrayOutputStream.toByteArray();
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> clazz) throws Exception {
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);
        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);
        return (T) objectInputStream.readObject();
    }
}
```

è¿™ç§è®¾è®¡å…è®¸åœ¨ä¸ä¿®æ”¹ä½¿ç”¨åºåˆ—åŒ–å™¨çš„ä»£ç çš„æƒ…å†µä¸‹ï¼Œåˆ‡æ¢ä¸åŒçš„åºåˆ—åŒ–ç­–ç•¥ï¼ˆå¦‚JDKåºåˆ—åŒ–ã€JSONåºåˆ—åŒ–ã€Protobufç­‰ï¼‰ã€‚

### 5.3 ä¼˜åŠ¿

- **ç®—æ³•å°è£…**ï¼šæ¯ç§åºåˆ—åŒ–ç­–ç•¥éƒ½è¢«å°è£…åœ¨ç‹¬ç«‹çš„ç±»ä¸­
- **å¯æ›¿æ¢æ€§**ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶åˆ‡æ¢ä¸åŒçš„åºåˆ—åŒ–ç­–ç•¥
- **å¼€é—­åŸåˆ™**ï¼šæ·»åŠ æ–°çš„åºåˆ—åŒ–ç­–ç•¥ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç 

## 6. é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰

### 6.1 å®šä¹‰ä¸ä½œç”¨

é€‚é…å™¨æ¨¡å¼å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·æœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œä½¿åŸæœ¬ä¸å…¼å®¹çš„æ¥å£å¯ä»¥ä¸€èµ·å·¥ä½œã€‚

### 6.2 é¡¹ç›®ä¸­çš„åº”ç”¨

`HttpServerHandler`ç±»å®ç°äº†Vert.xçš„`Handler<HttpServerRequest>`æ¥å£ï¼Œå°†HTTPè¯·æ±‚å¤„ç†é€»è¾‘é€‚é…åˆ°RPCå¤„ç†æµç¨‹ï¼š

```java
public class HttpServerHandler implements Handler<HttpServerRequest> {
    @Override
    public void handle(HttpServerRequest request) {
        request.bodyHandler(body -> {
            // ååºåˆ—åŒ–è¯·æ±‚
            RpcRequest rpcRequest = serializer.deserialize(body.getBytes(), RpcRequest.class);
            
            // å¤„ç†RPCè°ƒç”¨
            // ...
            
            // åºåˆ—åŒ–å“åº”
            byte[] bytes = serializer.serialize(rpcResponse);
            response.end(Buffer.buffer(bytes));
        });
    }
}
```

### 6.3 ä¼˜åŠ¿

- **å…¼å®¹æ€§**ï¼šä½¿ä¸å…¼å®¹çš„æ¥å£å¯ä»¥ä¸€èµ·å·¥ä½œ
- **å¤ç”¨**ï¼šå…è®¸å¤ç”¨ç°æœ‰åŠŸèƒ½è€Œä¸ä¿®æ”¹æºç 
- **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šå°†é€‚é…é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»

## æ€»ç»“

åœ¨learn-RPCé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åº”ç”¨äº†å¤šç§è®¾è®¡æ¨¡å¼æ¥è§£å†³ä¸åŒçš„è®¾è®¡é—®é¢˜ï¼š

1. **ä»£ç†æ¨¡å¼**ï¼šé€šè¿‡åŠ¨æ€ä»£ç†å®ç°è¿œç¨‹è°ƒç”¨çš„é€æ˜åŒ–
2. **å·¥å‚æ¨¡å¼**ï¼šç®€åŒ–ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹
3. **å•ä¾‹æ¨¡å¼**ï¼šç¡®ä¿å…¨å±€å”¯ä¸€çš„æ³¨å†Œä¸­å¿ƒå®ä¾‹
4. **å»ºé€ è€…æ¨¡å¼**ï¼šç®€åŒ–å¤æ‚å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹
5. **ç­–ç•¥æ¨¡å¼**ï¼šæ”¯æŒå¯æ›¿æ¢çš„åºåˆ—åŒ–ç­–ç•¥
6. **é€‚é…å™¨æ¨¡å¼**ï¼šå°†HTTPè¯·æ±‚å¤„ç†é€‚é…åˆ°RPCå¤„ç†æµç¨‹

è¿™äº›è®¾è®¡æ¨¡å¼çš„åº”ç”¨ä½¿å¾—é¡¹ç›®ä»£ç ç»“æ„æ¸…æ™°ã€æ˜“äºç»´æŠ¤å’Œæ‰©å±•ï¼ŒåŒæ—¶æé«˜äº†ä»£ç çš„å¤ç”¨æ€§å’Œå¯æµ‹è¯•æ€§ã€‚é€šè¿‡å­¦ä¹ è¿™äº›è®¾è®¡æ¨¡å¼åŠå…¶åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ç†è§£è½¯ä»¶è®¾è®¡çš„è‰ºæœ¯å’ŒåŸåˆ™ã€‚

## ğŸ¯ 3. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

### 3.1 æ¨¡å¼å®šä¹‰ä¸ä»·å€¼

ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼ŒæŠŠå®ƒä»¬ä¸€ä¸ªä¸ªå°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿å®ƒä»¬å¯ç›¸äº’æ›¿æ¢ã€‚åœ¨Ming RPC Frameworkä¸­ï¼Œç­–ç•¥æ¨¡å¼å¹¿æ³›åº”ç”¨äºå„ç§å¯æ›¿æ¢çš„ç®—æ³•å®ç°ã€‚

### 3.2 è´Ÿè½½å‡è¡¡ç­–ç•¥

#### LoadBalanceræ¥å£å®šä¹‰
```java
public interface LoadBalancer {
    /**
     * é€‰æ‹©æœåŠ¡è°ƒç”¨
     * @param requestParams è¯·æ±‚å‚æ•°
     * @param serviceMetaInfoList å¯ç”¨æœåŠ¡åˆ—è¡¨
     * @return é€‰ä¸­çš„æœåŠ¡
     */
    ServiceMetaInfo select(Map<String, Object> requestParams, List<ServiceMetaInfo> serviceMetaInfoList);
}
```

#### å…·ä½“ç­–ç•¥å®ç°
```java
// è½®è¯¢ç­–ç•¥
public class RoundRobinLoadBalancer implements LoadBalancer {
    private final AtomicInteger currentIndex = new AtomicInteger(0);

    @Override
    public ServiceMetaInfo select(Map<String, Object> requestParams, List<ServiceMetaInfo> serviceMetaInfoList) {
        int index = currentIndex.getAndIncrement() % serviceMetaInfoList.size();
        return serviceMetaInfoList.get(index);
    }
}

// ä¸€è‡´æ€§Hashç­–ç•¥
public class ConsistentHashLoadBalancer implements LoadBalancer {
    private final TreeMap<Integer, ServiceMetaInfo> virtualNodes = new TreeMap<>();

    @Override
    public ServiceMetaInfo select(Map<String, Object> requestParams, List<ServiceMetaInfo> serviceMetaInfoList) {
        // ä¸€è‡´æ€§Hashç®—æ³•å®ç°
        int hash = getHash(requestParams);
        Map.Entry<Integer, ServiceMetaInfo> entry = virtualNodes.ceilingEntry(hash);
        return entry != null ? entry.getValue() : virtualNodes.firstEntry().getValue();
    }
}
```

### 3.3 åºåˆ—åŒ–ç­–ç•¥

#### Serializeræ¥å£å®šä¹‰
```java
public interface Serializer {
    <T> byte[] serialize(T obj) throws IOException;
    <T> T deserialize(byte[] bytes, Class<T> clazz) throws IOException;
}
```

#### å…·ä½“ç­–ç•¥å®ç°
```java
// JDKåºåˆ—åŒ–ç­–ç•¥
public class JdkSerializer implements Serializer {
    @Override
    public <T> byte[] serialize(T obj) throws IOException {
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream);
        objectOutputStream.writeObject(obj);
        return outputStream.toByteArray();
    }
}

// JSONåºåˆ—åŒ–ç­–ç•¥
public class JsonSerializer implements Serializer {
    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    @Override
    public <T> byte[] serialize(T obj) throws IOException {
        return OBJECT_MAPPER.writeValueAsBytes(obj);
    }
}
```

### 3.4 å®¹é”™ç­–ç•¥

#### TolerantStrategyæ¥å£å®šä¹‰
```java
public interface TolerantStrategy {
    /**
     * å®¹é”™å¤„ç†
     * @param context ä¸Šä¸‹æ–‡
     * @param e å¼‚å¸¸
     * @return RPCå“åº”
     */
    RpcResponse doTolerant(Map<String, Object> context, Exception e);
}
```

#### å…·ä½“ç­–ç•¥å®ç°
```java
// å¿«é€Ÿå¤±è´¥ç­–ç•¥
public class FailFastTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        throw new RuntimeException("æœåŠ¡æŠ¥é”™", e);
    }
}

// æ•…éšœè½¬ç§»ç­–ç•¥
public class FailOverTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        // è·å–å…¶ä»–å¯ç”¨æœåŠ¡èŠ‚ç‚¹ï¼Œé‡æ–°è°ƒç”¨
        List<ServiceMetaInfo> serviceList = (List<ServiceMetaInfo>) context.get("serviceNodeList");
        ServiceMetaInfo failedNode = (ServiceMetaInfo) context.get("selectedNode");

        // ç§»é™¤å¤±è´¥èŠ‚ç‚¹ï¼Œé€‰æ‹©å…¶ä»–èŠ‚ç‚¹é‡è¯•
        serviceList.remove(failedNode);
        if (!serviceList.isEmpty()) {
            ServiceMetaInfo retryNode = serviceList.get(0);
            return doRetryCall(context, retryNode);
        }

        throw new RuntimeException("æ‰€æœ‰æœåŠ¡èŠ‚ç‚¹éƒ½ä¸å¯ç”¨", e);
    }
}
```

## ğŸ—ï¸ 4. å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰

### 4.1 æ¨¡å¼å®šä¹‰ä¸ä»·å€¼

å»ºé€ è€…æ¨¡å¼ä½¿ç”¨å¤šä¸ªç®€å•çš„å¯¹è±¡ä¸€æ­¥ä¸€æ­¥æ„å»ºæˆä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚

### 4.2 RpcRequestå»ºé€ è€…

#### RpcRequestå»ºé€ è€…å®ç°
```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RpcRequest implements Serializable {
    private String serviceName;
    private String methodName;
    private Class<?>[] parameterTypes;
    private Object[] args;

    // ä½¿ç”¨å»ºé€ è€…æ¨¡å¼åˆ›å»ºè¯·æ±‚å¯¹è±¡
    public static RpcRequestBuilder builder() {
        return new RpcRequestBuilder();
    }
}
```

#### ä½¿ç”¨ç¤ºä¾‹
```java
// ä½¿ç”¨å»ºé€ è€…æ¨¡å¼æ„å»ºRPCè¯·æ±‚
RpcRequest rpcRequest = RpcRequest.builder()
    .serviceName(UserService.class.getName())
    .methodName("getUser")
    .parameterTypes(new Class[]{User.class})
    .args(new Object[]{user})
    .build();
```

## ğŸ” 5. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰

### 5.1 æ¨¡å¼å®šä¹‰ä¸ä»·å€¼

è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚

### 5.2 æœåŠ¡æ³¨å†Œä¸­å¿ƒWatchæœºåˆ¶

#### Etcd Watchå®ç°
```java
@Override
public void watch(String serviceNodeKey) {
    Watch watchClient = client.getWatchClient();
    boolean newWatch = watchingKeySet.add(serviceNodeKey);
    if(newWatch){
        // å»ºç«‹è§‚å¯Ÿè€…å…³ç³»
        watchClient.watch(ByteSequence.from(serviceNodeKey, StandardCharsets.UTF_8), response -> {
            for(WatchEvent event : response.getEvents()){
                switch(event.getEventType()){
                    case DELETE:
                        // æœåŠ¡ä¸‹çº¿ï¼Œé€šçŸ¥ç¼“å­˜æ¸…ç†
                        registryServiceMultiCache.clearCache(serviceNodeKey);
                        log.info("æœåŠ¡ä¸‹çº¿ï¼Œæ¸…ç†ç¼“å­˜: {}", serviceNodeKey);
                        break;
                    case PUT:
                        log.debug("æœåŠ¡æ›´æ–°äº‹ä»¶: {}", serviceNodeKey);
                        break;
                    default:
                        break;
                }
            }
        });
    }
}
```

## ğŸ“‹ è®¾è®¡æ¨¡å¼æ€»ç»“

Ming RPC Frameworké€šè¿‡å·§å¦™è¿ç”¨å¤šç§è®¾è®¡æ¨¡å¼ï¼Œæ„å»ºäº†ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•ã€å¯ç»´æŠ¤çš„åˆ†å¸ƒå¼RPCæ¡†æ¶ï¼š

### ğŸ‰ æ ¸å¿ƒä»·å€¼
- **ä»£ç†æ¨¡å¼**: å®ç°è¿œç¨‹è°ƒç”¨é€æ˜åŒ–ï¼Œå±è”½ç½‘ç»œé€šä¿¡å¤æ‚æ€§
- **å·¥å‚æ¨¡å¼**: ç»Ÿä¸€ç»„ä»¶åˆ›å»ºï¼Œæ”¯æŒé…ç½®é©±åŠ¨å’ŒåŠ¨æ€æ‰©å±•
- **ç­–ç•¥æ¨¡å¼**: ç®—æ³•å¯æ›¿æ¢ï¼Œæ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ã€åºåˆ—åŒ–ã€å®¹é”™ç­–ç•¥
- **å»ºé€ è€…æ¨¡å¼**: ç®€åŒ–å¤æ‚å¯¹è±¡æ„å»ºï¼Œæä¾›é“¾å¼è°ƒç”¨ä½“éªŒ
- **è§‚å¯Ÿè€…æ¨¡å¼**: å®ç°æœåŠ¡çŠ¶æ€å˜åŒ–çš„å®æ—¶é€šçŸ¥

### ğŸ”§ æŠ€æœ¯ç‰¹è‰²
- **SPIé›†æˆ**: å·¥å‚æ¨¡å¼ä¸SPIæœºåˆ¶ç»“åˆï¼Œå®ç°çœŸæ­£çš„æ’ä»¶åŒ–
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€é€‰æ‹©ä¸åŒçš„ç­–ç•¥å®ç°
- **é»˜è®¤å®ç°**: æ¯ç§ç­–ç•¥éƒ½æä¾›åˆç†çš„é»˜è®¤å®ç°
- **é“¾å¼è°ƒç”¨**: å»ºé€ è€…æ¨¡å¼æä¾›ä¼˜é›…çš„APIè®¾è®¡

### ğŸ’¡ è®¾è®¡åŸåˆ™ä½“ç°
- **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **å•ä¸€èŒè´£**: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- **ä¾èµ–å€’ç½®**: ä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°
- **é‡Œæ°æ›¿æ¢**: å­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»ä½¿ç”¨

```mermaid
graph TD
    A[Ming RPC Framework] --> B[ä»£ç†æ¨¡å¼<br/>é€æ˜è°ƒç”¨]
    A --> C[å·¥å‚æ¨¡å¼<br/>ç»„ä»¶åˆ›å»º]
    A --> D[ç­–ç•¥æ¨¡å¼<br/>ç®—æ³•æ›¿æ¢]
    A --> E[å»ºé€ è€…æ¨¡å¼<br/>å¯¹è±¡æ„å»º]
    A --> F[è§‚å¯Ÿè€…æ¨¡å¼<br/>çŠ¶æ€é€šçŸ¥]

    B --> B1[ServiceProxy<br/>åŠ¨æ€ä»£ç†]
    C --> C1[RegistryFactory<br/>LoadBalancerFactory<br/>TolerantStrategyFactory]
    D --> D1[è´Ÿè½½å‡è¡¡ç­–ç•¥<br/>åºåˆ—åŒ–ç­–ç•¥<br/>å®¹é”™ç­–ç•¥]
    E --> E1[RpcRequest.builder<br/>RpcResponse.builder]
    F --> F1[Watchæœºåˆ¶<br/>ç¼“å­˜æ›´æ–°]

    style A fill:#e1f5fe
    style B fill:#e8f5e8
    style C fill:#fff3e0
    style D fill:#f3e5f5
    style E fill:#fce4ec
    style F fill:#e0f2f1
```

é€šè¿‡è¿™äº›è®¾è®¡æ¨¡å¼çš„åº”ç”¨ï¼ŒMing RPC Frameworkä¸ä»…å®ç°äº†åŠŸèƒ½çš„å®Œæ•´æ€§ï¼Œæ›´é‡è¦çš„æ˜¯ä¿è¯äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æµ‹è¯•æ€§ï¼Œä¸ºæ„å»ºä¼ä¸šçº§åˆ†å¸ƒå¼ç³»ç»Ÿæä¾›äº†åšå®çš„åŸºç¡€ã€‚