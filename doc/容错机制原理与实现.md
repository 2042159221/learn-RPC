# Ming RPC Framework å®¹é”™æœºåˆ¶åŸç†ä¸å®ç°è¯¦è§£

## ğŸ“– æ¦‚è¿°

å®¹é”™æœºåˆ¶æ˜¯åˆ†å¸ƒå¼RPCæ¡†æ¶çš„æ ¸å¿ƒå®‰å…¨ä¿éšœï¼Œè´Ÿè´£åœ¨æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶æä¾›å¤šç§æ¢å¤ç­–ç•¥ã€‚Ming RPC Frameworkå®ç°äº†ä¸€å¥—å®Œæ•´çš„ã€å¯æ‰©å±•çš„å®¹é”™ä½“ç³»ï¼Œæ”¯æŒå¤šç§å®¹é”™ç­–ç•¥ï¼Œé€šè¿‡SPIæœºåˆ¶å®ç°åŠ¨æ€æ‰©å±•ã€‚

## ğŸ¯ å®¹é”™æœºåˆ¶çš„ä½œç”¨

### æ ¸å¿ƒä»·å€¼
1. **æé«˜ç³»ç»Ÿå¯ç”¨æ€§**: åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­åº”å¯¹ç½‘ç»œæ•…éšœã€æœåŠ¡å®•æœºç­‰é—®é¢˜
2. **é˜²æ­¢çº§è”æ•…éšœ**: é˜»æ­¢æ•…éšœåœ¨å¾®æœåŠ¡è°ƒç”¨é“¾ä¸­è”“å»¶ï¼Œé¿å…"é›ªå´©æ•ˆåº”"
3. **å‡å°‘é”™è¯¯å½±å“èŒƒå›´**: é€šè¿‡éš”ç¦»ç­–ç•¥é™åˆ¶æ•…éšœå½±å“
4. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**: æä¾›æœåŠ¡é™çº§å’Œå‹å¥½çš„é”™è¯¯å¤„ç†
5. **ç³»ç»Ÿè‡ªæ„ˆèƒ½åŠ›**: æ”¯æŒæ•…éšœåçš„è‡ªåŠ¨æ¢å¤

### åœ¨RPCä¸­çš„ä½ç½®
```
RPCè°ƒç”¨ â†’ é‡è¯•æœºåˆ¶ â†’ å®¹é”™ç­–ç•¥ â†’ æœåŠ¡é™çº§/æ•…éšœè½¬ç§»/å¿«é€Ÿå¤±è´¥
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¥å£å®šä¹‰
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/TolerantStrategy.java`

```java
public interface TolerantStrategy {
    /**
     * å®¹é”™å¤„ç†
     * @param context ä¸Šä¸‹æ–‡ä¿¡æ¯
     * @param e å¼‚å¸¸
     * @return RPCå“åº”
     */
    RpcResponse doTolerant(Map<String, Object> context, Exception e);
}
```

### å®¹é”™ç­–ç•¥å¸¸é‡
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/TolerantStrategyKeys.java`

```java
public interface TolerantStrategyKeys {
    String FAIL_BACK = "failBack";      // æ•…éšœä¿®å¤(æœåŠ¡é™çº§)
    String FAIL_OVER = "failOver";      // æ•…éšœè½¬ç§»
    String FAIL_FAST = "failFast";      // å¿«é€Ÿå¤±è´¥
    String FAIL_SAFE = "failSafe";      // é™é»˜å¤„ç†
}
```

## ğŸ”§ å®¹é”™ç­–ç•¥å®ç°

### 1. å¿«é€Ÿå¤±è´¥ç­–ç•¥ (Fail Fast)
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/FailFastTolerantStrategy.java`

```java
public class FailFastTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        throw new RuntimeException("æœåŠ¡æŠ¥é”™", e);
    }
}
```

**ç­–ç•¥ç‰¹ç‚¹**:
- âœ… ç«‹å³é€šçŸ¥è°ƒç”¨æ–¹ï¼Œå¿«é€Ÿå“åº”
- âœ… å®ç°ç®€å•ï¼Œæ€§èƒ½å¼€é”€æœ€å°
- âœ… é€‚ç”¨äºå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯
- âŒ æ— æ³•æä¾›æœåŠ¡é™çº§
- âŒ ç”¨æˆ·ä½“éªŒè¾ƒå·®

**é€‚ç”¨åœºæ™¯**: é‡‘èäº¤æ˜“ã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡

### 2. é™é»˜å¤„ç†ç­–ç•¥ (Fail Safe)
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/FailSafeTolerantStrategy.java`

```java
public class FailSafeTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        log.info("é™é»˜å¤„ç†å¼‚å¸¸", e);
        return new RpcResponse();
    }
}
```

**ç­–ç•¥ç‰¹ç‚¹**:
- âœ… ä¸å½±å“ä¸»æµç¨‹ï¼Œç”¨æˆ·ä½“éªŒå¥½
- âœ… é€‚ç”¨äºéå…³é”®ä¸šåŠ¡
- âœ… ç³»ç»Ÿç¨³å®šæ€§é«˜
- âŒ å¯èƒ½æ©ç›–çœŸå®é—®é¢˜
- âŒ éš¾ä»¥å‘ç°ç³»ç»Ÿå¼‚å¸¸

**é€‚ç”¨åœºæ™¯**: æ—¥å¿—è®°å½•ã€ç»Ÿè®¡åˆ†æã€éå…³é”®åŠŸèƒ½
### 3. æœåŠ¡é™çº§ç­–ç•¥ (Fail Back)
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/FailBackTolerantStrategy.java`

```java
public class FailBackTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        log.info("Executing FailBack tolerant strategy.", e);

        // ä»ä¸Šä¸‹æ–‡ä¸­è·å– rpcRequest
        RpcRequest rpcRequest = (RpcRequest) context.get("rpcRequest");
        if (rpcRequest == null) {
            log.warn("RpcRequest not found in context, cannot perform failback.");
            return new RpcResponse();
        }

        // ä»å…¨å±€é…ç½®ä¸­è·å–é™çº§æœåŠ¡
        RpcConfig rpcConfig = RpcApplication.getRpcConfig();
        Class<?> mockService = rpcConfig.getMockServiceRegistry().get(rpcRequest.getServiceName());

        // å¦‚æœæ‰¾åˆ°äº†é™çº§æœåŠ¡ï¼Œåˆ™é€šè¿‡åå°„è°ƒç”¨
        if (mockService != null) {
            try {
                log.info("Found mock service for {}, executing fallback.", rpcRequest.getServiceName());
                Object mockInstance = mockService.getDeclaredConstructor().newInstance();
                Method method = mockService.getMethod(rpcRequest.getMethodName(), rpcRequest.getParameterTypes());
                Object result = method.invoke(mockInstance, rpcRequest.getArgs());

                // å°è£…æˆåŠŸå“åº”
                RpcResponse response = new RpcResponse();
                response.setData(result);
                response.setMessage("Fallback success");
                response.setMessageType(RpcResponse.MessageType.SUCCESS);
                return response;
            } catch (Exception reflectionException) {
                log.error("Failed to execute mock service via reflection.", reflectionException);
            }
        }

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é™çº§æœåŠ¡æˆ–åå°„å¤±è´¥ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„å“åº”
        log.warn("No mock service found for {}, returning empty response.", rpcRequest.getServiceName());
        return new RpcResponse();
    }
}
```

**ç­–ç•¥ç‰¹ç‚¹**:
- âœ… ä¿è¯ç³»ç»ŸåŸºæœ¬å¯ç”¨ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… é€šè¿‡MockæœåŠ¡æä¾›é™çº§åŠŸèƒ½
- âœ… æ”¯æŒåå°„è°ƒç”¨é™çº§æœåŠ¡
- âŒ éœ€è¦é¢å¤–å¼€å‘é™çº§é€»è¾‘
- âŒ åŠŸèƒ½å¯èƒ½å—é™

**é€‚ç”¨åœºæ™¯**: ç”µå•†æ¨èã€å†…å®¹å±•ç¤ºã€éæ ¸å¿ƒåŠŸèƒ½
### 4. æ•…éšœè½¬ç§»ç­–ç•¥ (Fail Over)
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/FailOverTolerantStrategy.java`

```java
public class FailOverTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        // ä»ä¸Šä¸‹æ–‡ä¸­è·å–æ‰€éœ€å‚æ•°
        List<ServiceMetaInfo> serviceNodeList = (List<ServiceMetaInfo>) context.get("serviceNodeList");
        ServiceMetaInfo failedNode = (ServiceMetaInfo) context.get("selectedNode");
        RpcRequest rpcRequest = (RpcRequest) context.get("rpcRequest");
        LoadBalancer loadBalancer = (LoadBalancer) context.get("loadBalancer");
        Retryer retryer = (Retryer) context.get("retryer");
        AtomicInteger retriedCount = (AtomicInteger) context.get("retriedCount");

        // ä»å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ä¸­ç§»é™¤å·²å¤±è´¥çš„èŠ‚ç‚¹
        List<ServiceMetaInfo> availableNodes = serviceNodeList.stream()
                .filter(node -> !node.equals(failedNode))
                .collect(Collectors.toList());

        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯ç”¨èŠ‚ç‚¹
        if (availableNodes.isEmpty()) {
            log.error("All service nodes failed, no node available for failover.", e);
            throw new RuntimeException("All service nodes failed.", e);
        }

        // æ„å»ºè´Ÿè½½å‡è¡¡å™¨æ‰€éœ€çš„è¯·æ±‚å‚æ•°Map
        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("methodName", rpcRequest.getMethodName());

        // ä»å‰©ä½™èŠ‚ç‚¹ä¸­é‡æ–°é€‰æ‹©ä¸€ä¸ª
        ServiceMetaInfo nextNode = loadBalancer.select(requestParams, availableNodes);
        log.info("Failing over to new node: {}", nextNode.getServiceAddress());

        // å¢åŠ é‡è¯•æ¬¡æ•°
        retriedCount.incrementAndGet();

        // ä½¿ç”¨é‡è¯•å™¨æ‰§è¡Œè°ƒç”¨
        return retryer.doRetry(rpcRequest, nextNode);
    }

    @FunctionalInterface
    public interface Retryer {
        RpcResponse doRetry(RpcRequest rpcRequest, ServiceMetaInfo serviceMetaInfo);
    }
}
```

**ç­–ç•¥ç‰¹ç‚¹**:
- âœ… è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å¯ç”¨æœåŠ¡å®ä¾‹
- âœ… ç»“åˆè´Ÿè½½å‡è¡¡å™¨æ™ºèƒ½é€‰æ‹©èŠ‚ç‚¹
- âœ… æé«˜ç³»ç»Ÿå¯ç”¨æ€§å’Œå®¹é”™èƒ½åŠ›
- âŒ éœ€è¦å¤šä¸ªæœåŠ¡å®ä¾‹
- âŒ å¯èƒ½å¢åŠ è°ƒç”¨å»¶è¿Ÿ

**é€‚ç”¨åœºæ™¯**: é«˜å¯ç”¨æœåŠ¡ã€é›†ç¾¤éƒ¨ç½²ã€å…³é”®ä¸šåŠ¡

## ğŸ­ å·¥å‚æ¨¡å¼ä¸SPIæœºåˆ¶

### å®¹é”™ç­–ç•¥å·¥å‚
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/java/com/ming/rpc/fault/tolerant/TolerantStrategyFactory.java`

```java
public class TolerantStrategyFactory {
    static {
        SpiLoader.load(TolerantStrategy.class);
    }

    /**
     * é»˜è®¤å®¹é”™ç­–ç•¥
     */
    private static final TolerantStrategy DEFAULT_TOLERANT_STRATEGY = new FailFastTolerantStrategy();

    /**
     * è·å–å®ä¾‹
     * @param key å®¹é”™ç­–ç•¥ç±»å‹
     * @return å®¹é”™ç­–ç•¥
     */
    public static TolerantStrategy getInstance(String key) {
        TolerantStrategy tolerantStrategy = SpiLoader.getInstance(TolerantStrategy.class, key);
        return tolerantStrategy == null ? DEFAULT_TOLERANT_STRATEGY : tolerantStrategy;
    }
}
```

### SPIé…ç½®æ–‡ä»¶
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/main/resources/META-INF/rpc/system/com.ming.rpc.fault.tolerant.TolerantStrategy`

```
failBack=com.ming.rpc.fault.tolerant.FailBackTolerantStrategy
failFast=com.ming.rpc.fault.tolerant.FailFastTolerantStrategy
failOver=com.ming.rpc.fault.tolerant.FailOverTolerantStrategy
failSafe=com.ming.rpc.fault.tolerant.FailSafeTolerantStrategy
```
## ğŸ§ª æµ‹è¯•éªŒè¯

### å®¹é”™ç­–ç•¥æµ‹è¯•
**æ–‡ä»¶è·¯å¾„**: `rpc-core/src/test/java/com/ming/rpc/fault/tolerant/`

é¡¹ç›®ä¸ºæ¯ä¸ªå®¹é”™ç­–ç•¥éƒ½æä¾›äº†å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼š

1. **FailFastTolerantStrategyTest** - å¿«é€Ÿå¤±è´¥ç­–ç•¥æµ‹è¯•
2. **FailSafeTolerantStrategyTest** - é™é»˜å¤„ç†ç­–ç•¥æµ‹è¯•
3. **FailBackTolerantStrategyTest** - æœåŠ¡é™çº§ç­–ç•¥æµ‹è¯•
4. **FailOverTolerantStrategyTest** - æ•…éšœè½¬ç§»ç­–ç•¥æµ‹è¯•

### æµ‹è¯•ç¤ºä¾‹
```java
@Test
void testFailBackStrategy_SuccessWithMock() {
    // å®‰æ’
    Map<String, Object> context = new HashMap<>();
    RpcRequest rpcRequest = new RpcRequest();
    rpcRequest.setServiceName(GreetingService.class.getName());
    rpcRequest.setMethodName("sayHello");
    rpcRequest.setParameterTypes(new Class[]{String.class});
    rpcRequest.setArgs(new Object[]{"World"});
    context.put("rpcRequest", rpcRequest);

    // è¡ŒåŠ¨
    RpcResponse response = failBackStrategy.doTolerant(context, new RuntimeException("Test exception"));

    // æ–­è¨€
    assertEquals(RpcResponse.MessageType.SUCCESS, response.getMessageType());
    assertEquals("Mocked Greeting for World", response.getData());
    assertEquals("Fallback success", response.getMessage());
}
```

## ğŸ“Š ç­–ç•¥å¯¹æ¯”

åŸºäºé¡¹ç›®æµ‹è¯•ç»“æœçš„ç­–ç•¥å¯¹æ¯”ï¼š

| å®¹é”™ç­–ç•¥ | å“åº”é€Ÿåº¦ | ç”¨æˆ·ä½“éªŒ | å®ç°å¤æ‚åº¦ | èµ„æºæ¶ˆè€— | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|-----------|----------|----------|
| å¿«é€Ÿå¤±è´¥ | æå¿«     | å·®       | ä½        | æœ€ä½     | é‡‘èäº¤æ˜“ |
| é™é»˜å¤„ç† | å¿«       | å¥½       | ä½        | ä½       | éå…³é”®åŠŸèƒ½ |
| æœåŠ¡é™çº§ | ä¸­ç­‰     | å¥½       | ä¸­ç­‰      | ä¸­ç­‰     | å†…å®¹å±•ç¤º |
| æ•…éšœè½¬ç§» | æ…¢       | å¥½       | é«˜        | é«˜       | å…³é”®ä¸šåŠ¡ |

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### é…ç½®å®¹é”™ç­–ç•¥
åœ¨RPCé…ç½®ä¸­æŒ‡å®šå®¹é”™ç­–ç•¥ï¼š

```yaml
rpc:
  tolerantStrategy: FAIL_FAST  # å¯é€‰: FAIL_FAST, FAIL_SAFE, FAIL_BACK, FAIL_OVER
```

### ä»£ç ä¸­ä½¿ç”¨
```java
// é€šè¿‡å·¥å‚è·å–å®¹é”™ç­–ç•¥
TolerantStrategy tolerantStrategy = TolerantStrategyFactory.getInstance(TolerantStrategyKeys.FAIL_BACK);

// æ„å»ºä¸Šä¸‹æ–‡
Map<String, Object> context = new HashMap<>();
context.put("rpcRequest", rpcRequest);

// æ‰§è¡Œå®¹é”™å¤„ç†
RpcResponse response = tolerantStrategy.doTolerant(context, exception);
```

### é…ç½®MockæœåŠ¡
```java
// æ³¨å†ŒMockæœåŠ¡ç”¨äºæœåŠ¡é™çº§
RpcConfig rpcConfig = RpcApplication.getRpcConfig();
rpcConfig.getMockServiceRegistry().put(UserService.class.getName(), UserServiceMock.class);
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å®¹é”™ç­–ç•¥é€‰æ‹©
- **å…³é”®ä¸šåŠ¡**: ä½¿ç”¨æ•…éšœè½¬ç§»ç­–ç•¥ï¼Œç¡®ä¿é«˜å¯ç”¨æ€§
- **éå…³é”®åŠŸèƒ½**: ä½¿ç”¨é™é»˜å¤„ç†ç­–ç•¥ï¼Œä¸å½±å“ä¸»æµç¨‹
- **ç”¨æˆ·ç•Œé¢**: ä½¿ç”¨æœåŠ¡é™çº§ç­–ç•¥ï¼Œæä¾›å‹å¥½çš„é™çº§ä½“éªŒ
- **é‡‘èäº¤æ˜“**: ä½¿ç”¨å¿«é€Ÿå¤±è´¥ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 2. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®å®¹é”™ç­–ç•¥çš„è¶…æ—¶æ—¶é—´
- ç¼“å­˜MockæœåŠ¡å®ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
- ç›‘æ§å®¹é”™ç­–ç•¥çš„æ‰§è¡Œæ•ˆæœ

### 3. ç›‘æ§å’Œè°ƒè¯•
- è®°å½•å®¹é”™ç­–ç•¥çš„è§¦å‘æƒ…å†µ
- ç›‘æ§æœåŠ¡é™çº§çš„ä½¿ç”¨é¢‘ç‡
- å®šæœŸåˆ†æå®¹é”™æ•ˆæœ

## ğŸ“ˆ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„å®¹é”™ç­–ç•¥
1. å®ç°`TolerantStrategy`æ¥å£
2. åœ¨SPIé…ç½®æ–‡ä»¶ä¸­æ³¨å†Œ
3. æ·»åŠ å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
4. æ›´æ–°å®¹é”™ç­–ç•¥å¸¸é‡

### ç¤ºä¾‹ï¼šæ·»åŠ é‡è¯•å®¹é”™ç­–ç•¥
```java
public class RetryTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        // é‡è¯•å®¹é”™ç­–ç•¥å®ç°
    }
}
```

## ğŸ“‹ æ€»ç»“

Ming RPC Frameworkçš„å®¹é”™æœºåˆ¶é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ï¼Œæä¾›äº†å…¨é¢ã€å¯é çš„å®¹é”™è§£å†³æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **å¤šç§ç­–ç•¥æ”¯æŒ**: å¿«é€Ÿå¤±è´¥ã€é™é»˜å¤„ç†ã€æœåŠ¡é™çº§ã€æ•…éšœè½¬ç§»å››ç§å®¹é”™ç­–ç•¥
- âœ… **SPIæœºåˆ¶æ‰©å±•**: é€šè¿‡SPIæœºåˆ¶å®ç°å®¹é”™ç­–ç•¥çš„åŠ¨æ€åŠ è½½å’Œæ‰©å±•
- âœ… **å·¥å‚æ¨¡å¼ç®¡ç†**: ç»Ÿä¸€çš„å®¹é”™ç­–ç•¥å·¥å‚ç®¡ç†å’Œåˆ›å»º
- âœ… **å®Œå–„çš„æµ‹è¯•**: æ¯ä¸ªå®¹é”™ç­–ç•¥éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯
- âœ… **åœºæ™¯é€‚é…**: é’ˆå¯¹ä¸åŒåœºæ™¯æä¾›æœ€ä¼˜çš„å®¹é”™ç­–ç•¥

### æŠ€æœ¯ç‰¹è‰²
- **å¯æ’æ‹”è®¾è®¡**: é€šè¿‡æ¥å£æŠ½è±¡å’ŒSPIæœºåˆ¶å®ç°å¯æ’æ‹”
- **æœåŠ¡é™çº§**: æ”¯æŒMockæœåŠ¡çš„è‡ªåŠ¨é™çº§æœºåˆ¶
- **æ•…éšœè½¬ç§»**: æ™ºèƒ½çš„èŠ‚ç‚¹åˆ‡æ¢å’Œè´Ÿè½½å‡è¡¡
- **ä¸Šä¸‹æ–‡ä¼ é€’**: ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯æ”¯æŒå¤æ‚å®¹é”™é€»è¾‘

## ğŸ“Š å®¹é”™ç­–ç•¥å¯¹æ¯”

åŸºäºé¡¹ç›®å®é™…å®ç°çš„å®¹é”™ç­–ç•¥å¯¹æ¯”ï¼š

| ç­–ç•¥ | å“åº”æ—¶é—´ | ç”¨æˆ·ä½“éªŒ | ç³»ç»Ÿç¨³å®šæ€§ | å®ç°å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|-----------|-----------|----------|
| å¿«é€Ÿå¤±è´¥ | æå¿« | å·® | ä¸­ç­‰ | æä½ | é‡‘èäº¤æ˜“ã€æ•°æ®ä¸€è‡´æ€§ |
| é™é»˜å¤„ç† | å¿« | å¥½ | é«˜ | ä½ | æ—¥å¿—è®°å½•ã€ç»Ÿè®¡åˆ†æ |
| æœåŠ¡é™çº§ | ä¸­ç­‰ | å¥½ | é«˜ | é«˜ | æ¨èç³»ç»Ÿã€å†…å®¹å±•ç¤º |
| æ•…éšœè½¬ç§» | æ…¢ | ä¸­ç­‰ | æé«˜ | ä¸­ç­‰ | å…³é”®ä¸šåŠ¡ã€é›†ç¾¤æœåŠ¡ |

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### é…ç½®å®¹é”™ç­–ç•¥
åœ¨RPCé…ç½®ä¸­æŒ‡å®šå®¹é”™ç­–ç•¥ï¼š

```yaml
rpc:
  tolerantStrategy: failFast  # å¯é€‰: failFast, failSafe, failBack, failOver
```

### ä»£ç ä¸­ä½¿ç”¨
```java
// é€šè¿‡å·¥å‚è·å–å®¹é”™ç­–ç•¥
TolerantStrategy strategy = TolerantStrategyFactory.getInstance("failOver");

// åœ¨RPCè°ƒç”¨å¤±è´¥æ—¶æ‰§è¡Œå®¹é”™å¤„ç†
Map<String, Object> context = new HashMap<>();
context.put("rpcRequest", rpcRequest);
context.put("serviceNodeList", serviceList);
context.put("selectedNode", failedNode);

RpcResponse response = strategy.doTolerant(context, exception);
```

### è‡ªå®šä¹‰å®¹é”™ç­–ç•¥
1. å®ç°TolerantStrategyæ¥å£
2. åœ¨SPIé…ç½®æ–‡ä»¶ä¸­æ³¨å†Œ
3. é€šè¿‡é…ç½®ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥

```java
// è‡ªå®šä¹‰å®¹é”™ç­–ç•¥
public class CustomTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        // è‡ªå®šä¹‰å®¹é”™é€»è¾‘
        return new RpcResponse();
    }
}
```

é…ç½®æ–‡ä»¶ï¼š`META-INF/rpc/custom/com.ming.rpc.fault.tolerant.TolerantStrategy`
```
custom=com.example.CustomTolerantStrategy
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç­–ç•¥é€‰æ‹©åŸåˆ™
- **é‡‘èæ”¯ä»˜**: ä½¿ç”¨å¿«é€Ÿå¤±è´¥ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **ç”¨æˆ·æ¨è**: ä½¿ç”¨æœåŠ¡é™çº§ï¼Œæä¾›é»˜è®¤æ¨è
- **æ—¥å¿—æ”¶é›†**: ä½¿ç”¨é™é»˜å¤„ç†ï¼Œä¸å½±å“ä¸»æµç¨‹
- **æ ¸å¿ƒæœåŠ¡**: ä½¿ç”¨æ•…éšœè½¬ç§»ï¼Œä¿è¯é«˜å¯ç”¨

### 2. å®¹é”™ç­–ç•¥ç»„åˆ
```java
// å¤šå±‚å®¹é”™ç­–ç•¥
public class MultiLevelTolerantStrategy implements TolerantStrategy {
    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        // 1. é¦–å…ˆå°è¯•æ•…éšœè½¬ç§»
        try {
            return failOverStrategy.doTolerant(context, e);
        } catch (Exception ex) {
            // 2. æ•…éšœè½¬ç§»å¤±è´¥ï¼Œå°è¯•æœåŠ¡é™çº§
            return failBackStrategy.doTolerant(context, ex);
        }
    }
}
```

### 3. ç›‘æ§å’Œå‘Šè­¦
- è®°å½•å®¹é”™ç­–ç•¥çš„æ‰§è¡Œæ¬¡æ•°å’ŒæˆåŠŸç‡
- è®¾ç½®å®¹é”™é˜ˆå€¼å‘Šè­¦
- ç›‘æ§æœåŠ¡é™çº§çš„ä½¿ç”¨æƒ…å†µ

### 4. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- é¿å…è¿‡åº¦é‡è¯•
- ç¼“å­˜é™çº§æ•°æ®

## ğŸ“ˆ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„å®¹é”™ç­–ç•¥
1. å®ç°TolerantStrategyæ¥å£
2. æ·»åŠ ç­–ç•¥å¸¸é‡
3. åˆ›å»ºSPIé…ç½®
4. å®ç°å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹

### ç¤ºä¾‹ï¼šæ·»åŠ ç†”æ–­å™¨ç­–ç•¥
```java
// 1. å®šä¹‰ç†”æ–­å™¨ç­–ç•¥
public class CircuitBreakerTolerantStrategy implements TolerantStrategy {
    private final CircuitBreaker circuitBreaker = new CircuitBreaker();

    @Override
    public RpcResponse doTolerant(Map<String, Object> context, Exception e) {
        if (circuitBreaker.isOpen()) {
            // ç†”æ–­å™¨æ‰“å¼€ï¼Œç›´æ¥è¿”å›é™çº§å“åº”
            return getFallbackResponse();
        }

        // è®°å½•å¤±è´¥æ¬¡æ•°
        circuitBreaker.recordFailure();

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰“å¼€ç†”æ–­å™¨
        if (circuitBreaker.shouldOpen()) {
            circuitBreaker.open();
        }

        throw new RuntimeException("Circuit breaker activated", e);
    }
}

// 2. æ·»åŠ åˆ°å¸¸é‡ç±»
public interface TolerantStrategyKeys {
    String CIRCUIT_BREAKER = "circuitBreaker";
}

// 3. SPIé…ç½®
circuitBreaker=com.ming.rpc.fault.tolerant.CircuitBreakerTolerantStrategy
```

## ğŸ“‹ æ€»ç»“

Ming RPC Frameworkçš„å®¹é”™æœºåˆ¶é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ï¼Œæä¾›äº†å®Œæ•´ã€å¯é çš„æ•…éšœå¤„ç†è§£å†³æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **å¤šç§å®¹é”™ç­–ç•¥**: å¿«é€Ÿå¤±è´¥ã€é™é»˜å¤„ç†ã€æœåŠ¡é™çº§ã€æ•…éšœè½¬ç§»å››ç§ç­–ç•¥
- âœ… **SPIæœºåˆ¶æ‰©å±•**: é€šè¿‡SPIæœºåˆ¶å®ç°å®¹é”™ç­–ç•¥çš„åŠ¨æ€åŠ è½½å’Œæ‰©å±•
- âœ… **å·¥å‚æ¨¡å¼ç®¡ç†**: ç»Ÿä¸€çš„å®¹é”™ç­–ç•¥å·¥å‚ç®¡ç†å’Œåˆ›å»º
- âœ… **å®Œå–„çš„æµ‹è¯•**: æ¯ä¸ªå®¹é”™ç­–ç•¥éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯
- âœ… **åœºæ™¯é€‚é…**: é’ˆå¯¹ä¸åŒä¸šåŠ¡åœºæ™¯æä¾›æœ€ä¼˜çš„å®¹é”™ç­–ç•¥

### æŠ€æœ¯ç‰¹è‰²
- **å¯æ’æ‹”è®¾è®¡**: é€šè¿‡æ¥å£æŠ½è±¡å’ŒSPIæœºåˆ¶å®ç°å¯æ’æ‹”
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶ä½¿ç”¨å“ªç§å®¹é”™ç­–ç•¥
- **ä¸Šä¸‹æ–‡ä¼ é€’**: ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯æ”¯æŒå¤æ‚çš„å®¹é”™é€»è¾‘
- **ç»„åˆä½¿ç”¨**: æ”¯æŒå¤šç§å®¹é”™ç­–ç•¥çš„ç»„åˆä½¿ç”¨

### å®¹é”™èƒ½åŠ›
- **å¿«é€Ÿå¤±è´¥**: ç«‹å³æš´éœ²é—®é¢˜ï¼Œé€‚ç”¨äºå¼ºä¸€è‡´æ€§åœºæ™¯
- **é™é»˜å¤„ç†**: ä¿è¯ä¸»æµç¨‹ä¸å—å½±å“ï¼Œé€‚ç”¨äºéå…³é”®ä¸šåŠ¡
- **æœåŠ¡é™çº§**: æä¾›åŸºæœ¬åŠŸèƒ½ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒ
- **æ•…éšœè½¬ç§»**: è‡ªåŠ¨åˆ‡æ¢æœåŠ¡èŠ‚ç‚¹ï¼Œä¿è¯é«˜å¯ç”¨æ€§

Ming RPC Frameworkçš„å®¹é”™æœºåˆ¶ä¸ºåˆ†å¸ƒå¼RPCè°ƒç”¨æä¾›äº†å¼ºæœ‰åŠ›çš„å¯é æ€§ä¿éšœï¼Œç¡®ä¿äº†ç³»ç»Ÿåœ¨é¢å¯¹å„ç§æ•…éšœæ—¶çš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚